{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Faraway-Frustum \u6a21\u5757\u6587\u6863\uff08\u7b97\u5b50\u7ea7\u91cd\u6784\u7248\uff09 \u00b6 \u672c\u7f51\u7ad9\u5c55\u793a\u4e86\u57fa\u4e8e\u7b97\u5b50\uff08operator\uff09\u65b9\u5f0f\u91cd\u6784\u7684 Faraway-Frustum \u4e24\u9636\u6bb5\u878d\u5408\u6846\u67b6 \uff0c\u5305\u62ec\uff1a Stage1\uff1aFrustum \u6784\u5efa\u9636\u6bb5 (Frustum Construction) Stage2\uff1aFaraway \u7ec6\u5316\u9636\u6bb5 (Faraway Refinement) Near \u5206\u652f\uff1a\u8fd1\u8ddd\u79bb 3D \u68c0\u6d4b\u63a5\u53e3 Faraway-Frustum \u4e3b\u878d\u5408\u6846\u67b6 (Framework) \u672c\u9879\u76ee\u91c7\u7528 Tensor-only \u7b97\u5b50\u8bbe\u8ba1 \uff0c\u6240\u6709\u4e2d\u95f4\u6570\u636e\u5747\u4ee5 Tensor \u5f62\u5f0f\u6d41\u52a8\uff0c \u907f\u514d List[Tensor] \u5e26\u6765\u7684 custom_op \u8c03\u5ea6\u95ee\u9898\u3002 \u6240\u6709\u7b97\u5b50\u6587\u6863\u5747\u7531 mkdocstrings \u81ea\u52a8\u4ece\u6e90\u4ee3\u7801 docstring \u751f\u6210\u3002 \ud83d\udd37 \u6846\u67b6\u6574\u4f53\u7ed3\u6784 \u00b6 Faraway-Frustum \u6846\u67b6\u5206\u4e3a\u4e24\u4e2a\u4e3b\u8981\u9636\u6bb5\uff1a Stage1\uff1aFrustum Construction \u00b6 \u57fa\u4e8e 2D \u5b9e\u4f8b\u4fe1\u606f\uff0c\u4ece\u539f\u59cb\u70b9\u4e91\u4e2d\u88c1\u526a\u51fa\u5019\u9009 Frustum \u70b9\u4e91\uff0c \u5e76\u4f30\u8ba1\u76ee\u6807\u8d28\u5fc3\u4e0e\u8fdc\u8fd1\u7c7b\u522b\u3002 \u5305\u542b\u7b97\u5b50\uff1a mask_frustum_pointcloud_crop frustum_histogram_clustering faraway_object_decision Stage2\uff1aFaraway Refinement \u00b6 \u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u51e0\u4f55\u5bf9\u9f50\u3001\u5750\u6807\u5f52\u4e00\u5316\u4e0e BEV \u6295\u5f71\uff0c \u518d\u901a\u8fc7 FF-Net \u8fdb\u884c 3D Box \u56de\u5f52\u3002 \u5305\u542b\u7b97\u5b50\uff1a frustum_axis_alignment centroid_coordinate_transform frustum_bev_projection FarawayFrustumBoxRegression assemble_faraway_3d_box Near \u5206\u652f \u00b6 \u8fd1\u8ddd\u79bb\u76ee\u6807\u76f4\u63a5\u8c03\u7528\uff1a Near3DDetectionInterface \ud83d\udccc \u6587\u6863\u5bfc\u822a\uff08\u5feb\u901f\u8df3\u8f6c\uff09 \u00b6 Frustum_Construction.md Faraway_Refinement.md framework.md","title":"\u6587\u6863\u9996\u9875"},{"location":"#faraway-frustum","text":"\u672c\u7f51\u7ad9\u5c55\u793a\u4e86\u57fa\u4e8e\u7b97\u5b50\uff08operator\uff09\u65b9\u5f0f\u91cd\u6784\u7684 Faraway-Frustum \u4e24\u9636\u6bb5\u878d\u5408\u6846\u67b6 \uff0c\u5305\u62ec\uff1a Stage1\uff1aFrustum \u6784\u5efa\u9636\u6bb5 (Frustum Construction) Stage2\uff1aFaraway \u7ec6\u5316\u9636\u6bb5 (Faraway Refinement) Near \u5206\u652f\uff1a\u8fd1\u8ddd\u79bb 3D \u68c0\u6d4b\u63a5\u53e3 Faraway-Frustum \u4e3b\u878d\u5408\u6846\u67b6 (Framework) \u672c\u9879\u76ee\u91c7\u7528 Tensor-only \u7b97\u5b50\u8bbe\u8ba1 \uff0c\u6240\u6709\u4e2d\u95f4\u6570\u636e\u5747\u4ee5 Tensor \u5f62\u5f0f\u6d41\u52a8\uff0c \u907f\u514d List[Tensor] \u5e26\u6765\u7684 custom_op \u8c03\u5ea6\u95ee\u9898\u3002 \u6240\u6709\u7b97\u5b50\u6587\u6863\u5747\u7531 mkdocstrings \u81ea\u52a8\u4ece\u6e90\u4ee3\u7801 docstring \u751f\u6210\u3002","title":"Faraway-Frustum \u6a21\u5757\u6587\u6863\uff08\u7b97\u5b50\u7ea7\u91cd\u6784\u7248\uff09"},{"location":"#_1","text":"Faraway-Frustum \u6846\u67b6\u5206\u4e3a\u4e24\u4e2a\u4e3b\u8981\u9636\u6bb5\uff1a","title":"\ud83d\udd37 \u6846\u67b6\u6574\u4f53\u7ed3\u6784"},{"location":"#stage1frustum-construction","text":"\u57fa\u4e8e 2D \u5b9e\u4f8b\u4fe1\u606f\uff0c\u4ece\u539f\u59cb\u70b9\u4e91\u4e2d\u88c1\u526a\u51fa\u5019\u9009 Frustum \u70b9\u4e91\uff0c \u5e76\u4f30\u8ba1\u76ee\u6807\u8d28\u5fc3\u4e0e\u8fdc\u8fd1\u7c7b\u522b\u3002 \u5305\u542b\u7b97\u5b50\uff1a mask_frustum_pointcloud_crop frustum_histogram_clustering faraway_object_decision","title":"Stage1\uff1aFrustum Construction"},{"location":"#stage2faraway-refinement","text":"\u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u51e0\u4f55\u5bf9\u9f50\u3001\u5750\u6807\u5f52\u4e00\u5316\u4e0e BEV \u6295\u5f71\uff0c \u518d\u901a\u8fc7 FF-Net \u8fdb\u884c 3D Box \u56de\u5f52\u3002 \u5305\u542b\u7b97\u5b50\uff1a frustum_axis_alignment centroid_coordinate_transform frustum_bev_projection FarawayFrustumBoxRegression assemble_faraway_3d_box","title":"Stage2\uff1aFaraway Refinement"},{"location":"#near","text":"\u8fd1\u8ddd\u79bb\u76ee\u6807\u76f4\u63a5\u8c03\u7528\uff1a Near3DDetectionInterface","title":"Near \u5206\u652f"},{"location":"#_2","text":"Frustum_Construction.md Faraway_Refinement.md framework.md","title":"\ud83d\udccc \u6587\u6863\u5bfc\u822a\uff08\u5feb\u901f\u8df3\u8f6c\uff09"},{"location":"Faraway_Refinement/","text":"Stage 2 \u2013 Faraway Refinement\uff08Faraway \u7ec6\u5316\u9636\u6bb5\uff09 \u00b6 \ud83d\udca1 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u51e0\u4f55\u5bf9\u9f50\u3001\u5c40\u90e8\u5750\u6807\u5f52\u4e00\u5316\u4e0e BEV \u8868\u793a\u6784\u5efa\uff0c\u5e76\u901a\u8fc7\u53ef\u5b66\u4e60\u7f51\u7edc\u56de\u5f52\u6700\u7ec8 3D \u6846\u53c2\u6570 \uff0c \u4ece\u800c\u63d0\u5347\u8fdc\u8ddd\u79bb\u76ee\u6807\u7684\u5b9a\u4f4d\u7cbe\u5ea6\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e94\u4e2a\u7b97\u5b50\uff1a frustum_axis_alignment \u5bf9 Frustum \u70b9\u4e91\u8fdb\u884c\u5750\u6807\u65cb\u8f6c\uff0c\u4f7f\u5176\u4e0e\u76ee\u6807\u4e3b\u65b9\u5411\u5bf9\u9f50\u3002 centroid_coordinate_transform \u5c06\u70b9\u4e91\u8f6c\u6362\u5230\u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u7cfb\u3002 frustum_bev_projection \u5c06\u5c40\u90e8\u70b9\u4e91\u6295\u5f71\u4e3a BEV \u8868\u793a\uff0c\u7528\u4e8e\u540e\u7eed\u7f51\u7edc\u56de\u5f52\u3002 FarawayFrustumBoxRegression \u57fa\u4e8e BEV \u7279\u5f81\u8fdb\u884c 3D Box \u53c2\u6570\u56de\u5f52\u7684\u53ef\u5b66\u4e60\u7f51\u7edc\uff08FF-Net\uff09\u3002 assemble_faraway_3d_box \u6839\u636e\u8d28\u5fc3\u4e0e\u56de\u5f52\u7ed3\u679c\u7ec4\u88c5\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u6846\u3002 API \u6587\u6863 \u00b6 frustum_axis_alignment \u00b6 frustum_axis_alignment ( clusters , counts , frustum_angles ) \u00b6 Frustum \u5750\u6807\u8f74\u5bf9\u9f50\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u6839\u636e\u5176\u5bf9\u5e94\u7684\u89c6\u9525\u65b9\u5411\u89d2\u8fdb\u884c\u65cb\u8f6c\uff0c \u7edf\u4e00\u5bf9\u9f50\u5230\u6807\u51c6\u5750\u6807\u7cfb\u65b9\u5411\uff0c\u4ece\u800c\u6d88\u9664\u76f8\u673a\u89c6\u89d2\u5e26\u6765\u7684\u65b9\u5411\u5dee\u5f02\uff0c \u4e3a\u540e\u7eed\u8d28\u5fc3\u5e73\u79fb\u4e0e BEV \u6295\u5f71\u63d0\u4f9b\u7a33\u5b9a\u8f93\u5165\u3002 Parameters: frustum_clusters \u2013 List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 frustum_angles ( Tensor ) \u2013 (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u671d\u5411\u89d2\uff08\u7ed5 Y \u8f74\u65cb\u8f6c\u89d2\u5ea6\uff0c\u5355\u4f4d\uff1a\u5f27\u5ea6\uff09\u3002 Returns: aligned_clusters ( Tensor ) \u2013 List[(Ni, 3)] \u65cb\u8f6c\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\u3002 Source code in Faraway_Refinement\\operator\\frustum_axis_alignment.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @torch . library . custom_op ( \"faraway::frustum_axis_alignment\" , mutates_args = []) def frustum_axis_alignment ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) frustum_angles : torch . Tensor , # (K,) ) -> torch . Tensor : \"\"\" Frustum \u5750\u6807\u8f74\u5bf9\u9f50\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u6839\u636e\u5176\u5bf9\u5e94\u7684\u89c6\u9525\u65b9\u5411\u89d2\u8fdb\u884c\u65cb\u8f6c\uff0c \u7edf\u4e00\u5bf9\u9f50\u5230\u6807\u51c6\u5750\u6807\u7cfb\u65b9\u5411\uff0c\u4ece\u800c\u6d88\u9664\u76f8\u673a\u89c6\u89d2\u5e26\u6765\u7684\u65b9\u5411\u5dee\u5f02\uff0c \u4e3a\u540e\u7eed\u8d28\u5fc3\u5e73\u79fb\u4e0e BEV \u6295\u5f71\u63d0\u4f9b\u7a33\u5b9a\u8f93\u5165\u3002 Args: frustum_clusters: List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 frustum_angles: (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u671d\u5411\u89d2\uff08\u7ed5 Y \u8f74\u65cb\u8f6c\u89d2\u5ea6\uff0c\u5355\u4f4d\uff1a\u5f27\u5ea6\uff09\u3002 Returns: aligned_clusters: List[(Ni, 3)] \u65cb\u8f6c\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\u3002 \"\"\" device = clusters . device aligned = torch . zeros_like ( clusters ) K = int ( clusters . shape [ 0 ]) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue theta = frustum_angles [ i ] c = torch . cos ( theta ) s = torch . sin ( theta ) rot = torch . stack ([ torch . stack ([ c , torch . tensor ( 0.0 , device = device ), s ]), torch . stack ([ torch . tensor ( 0.0 , device = device ), torch . tensor ( 1.0 , device = device ), torch . tensor ( 0.0 , device = device )]), torch . stack ([ - s , torch . tensor ( 0.0 , device = device ), c ]), ], dim = 0 ) . to ( clusters . dtype ) # (3,3) pts = clusters [ i , : n , :] # (n,3) aligned [ i , : n , :] = pts @ rot . T return aligned centroid_coordinate_transform \u00b6 centroid_coordinate_transform ( clusters , counts , centroids ) \u00b6 \u8d28\u5fc3\u5750\u6807\u5f52\u4e00\u5316\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u5e73\u79fb\u5230\u4ee5\u76ee\u6807\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u7cfb\uff0c \u5373\u5bf9\u70b9\u4e91\u4e2d\u7684\u6bcf\u4e2a\u70b9\u51cf\u53bb\u5bf9\u5e94\u5b9e\u4f8b\u7684\u8d28\u5fc3\u5750\u6807\u3002 \u901a\u8fc7\u8be5\u53d8\u6362\uff0c\u5c06\u5168\u5c40\u5b9a\u4f4d\u95ee\u9898\u8f6c\u6362\u4e3a\u5c40\u90e8\u7ed3\u6784\u5efa\u6a21\u95ee\u9898\uff0c \u6709\u5229\u4e8e\u540e\u7eed BEV \u6295\u5f71\u4e0e\u8f7b\u91cf\u7f51\u7edc\u56de\u5f52\u3002 Parameters: aligned_clusters \u2013 List[(Ni, 3)] \u7ecf\u8fc7\u65b9\u5411\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 centroids ( Tensor ) \u2013 (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 Returns: local_clusters ( Tensor ) \u2013 List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u70b9\u4e91\u96c6\u5408\u3002 Source code in Faraway_Refinement\\operator\\centroid_coordinate_transform.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 @torch . library . custom_op ( \"faraway::centroid_coordinate_transform\" , mutates_args = []) def centroid_coordinate_transform ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) centroids : torch . Tensor , # (K, 3) ) -> torch . Tensor : \"\"\" \u8d28\u5fc3\u5750\u6807\u5f52\u4e00\u5316\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u5e73\u79fb\u5230\u4ee5\u76ee\u6807\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u7cfb\uff0c \u5373\u5bf9\u70b9\u4e91\u4e2d\u7684\u6bcf\u4e2a\u70b9\u51cf\u53bb\u5bf9\u5e94\u5b9e\u4f8b\u7684\u8d28\u5fc3\u5750\u6807\u3002 \u901a\u8fc7\u8be5\u53d8\u6362\uff0c\u5c06\u5168\u5c40\u5b9a\u4f4d\u95ee\u9898\u8f6c\u6362\u4e3a\u5c40\u90e8\u7ed3\u6784\u5efa\u6a21\u95ee\u9898\uff0c \u6709\u5229\u4e8e\u540e\u7eed BEV \u6295\u5f71\u4e0e\u8f7b\u91cf\u7f51\u7edc\u56de\u5f52\u3002 Args: aligned_clusters: List[(Ni, 3)] \u7ecf\u8fc7\u65b9\u5411\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 centroids: (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 Returns: local_clusters: List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u70b9\u4e91\u96c6\u5408\u3002 \"\"\" local = torch . zeros_like ( clusters ) K = int ( clusters . shape [ 0 ]) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue local [ i , : n , :] = clusters [ i , : n , :] - centroids [ i ] . unsqueeze ( 0 ) return local frustum_bev_projection \u00b6 frustum_bev_projection ( clusters , counts , bev_height , bev_width , x_range , z_range ) \u00b6 Frustum \u70b9\u4e91 BEV \u6295\u5f71\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a\u5b9e\u4f8b\u5728\u5c40\u90e8\u5750\u6807\u7cfb\u4e0b\u7684\u4e09\u7ef4\u70b9\u4e91 \u6295\u5f71\u5230 Bird's Eye View (BEV) \u5e73\u9762\uff0c \u751f\u6210\u56fa\u5b9a\u5c3a\u5bf8\u7684\u4e8c\u7ef4\u6805\u683c\u8868\u793a\uff0c\u7528\u4e8e\u540e\u7eed\u8f7b\u91cf\u56de\u5f52\u7f51\u7edc\u8f93\u5165\u3002 \u6295\u5f71\u65b9\u5f0f\uff1a - \u4f7f\u7528 (x, z) \u5e73\u9762\u6784\u5efa BEV - \u7edf\u8ba1\u6bcf\u4e2a\u6805\u683c\u4e2d\u7684\u70b9\u6570\u4f5c\u4e3a\u5f3a\u5ea6\u503c Parameters: local_clusters \u2013 List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u70b9\u4e91\u96c6\u5408\u3002 bev_height ( int ) \u2013 int BEV \u6805\u683c\u9ad8\u5ea6\u3002 bev_width ( int ) \u2013 int BEV \u6805\u683c\u5bbd\u5ea6\u3002 x_range ( float ) \u2013 float BEV \u5728 x \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-x_range, x_range]\uff09\u3002 z_range ( float ) \u2013 float BEV \u5728 z \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-z_range, z_range]\uff09\u3002 Returns: bev_maps ( Tensor ) \u2013 (K, 1, H, W) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 BEV \u6295\u5f71\u7ed3\u679c\uff0c \u5355\u901a\u9053\u8868\u793a\u70b9\u6570\u5bc6\u5ea6\u3002 Source code in Faraway_Refinement\\operator\\frustum_bev_projection.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 @torch . library . custom_op ( \"faraway::frustum_bev_projection\" , mutates_args = []) def frustum_bev_projection ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) bev_height : int , bev_width : int , x_range : float , z_range : float , ) -> torch . Tensor : \"\"\" Frustum \u70b9\u4e91 BEV \u6295\u5f71\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a\u5b9e\u4f8b\u5728\u5c40\u90e8\u5750\u6807\u7cfb\u4e0b\u7684\u4e09\u7ef4\u70b9\u4e91 \u6295\u5f71\u5230 Bird's Eye View (BEV) \u5e73\u9762\uff0c \u751f\u6210\u56fa\u5b9a\u5c3a\u5bf8\u7684\u4e8c\u7ef4\u6805\u683c\u8868\u793a\uff0c\u7528\u4e8e\u540e\u7eed\u8f7b\u91cf\u56de\u5f52\u7f51\u7edc\u8f93\u5165\u3002 \u6295\u5f71\u65b9\u5f0f\uff1a - \u4f7f\u7528 (x, z) \u5e73\u9762\u6784\u5efa BEV - \u7edf\u8ba1\u6bcf\u4e2a\u6805\u683c\u4e2d\u7684\u70b9\u6570\u4f5c\u4e3a\u5f3a\u5ea6\u503c Args: local_clusters: List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u70b9\u4e91\u96c6\u5408\u3002 bev_height: int BEV \u6805\u683c\u9ad8\u5ea6\u3002 bev_width: int BEV \u6805\u683c\u5bbd\u5ea6\u3002 x_range: float BEV \u5728 x \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-x_range, x_range]\uff09\u3002 z_range: float BEV \u5728 z \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-z_range, z_range]\uff09\u3002 Returns: bev_maps: (K, 1, H, W) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 BEV \u6295\u5f71\u7ed3\u679c\uff0c \u5355\u901a\u9053\u8868\u793a\u70b9\u6570\u5bc6\u5ea6\u3002 \"\"\" device = clusters . device K = int ( clusters . shape [ 0 ]) bev_maps = torch . zeros (( K , 1 , bev_height , bev_width ), device = device , dtype = clusters . dtype ) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue pts = clusters [ i , : n , :] x = pts [:, 0 ] z = pts [:, 2 ] x_norm = ( x + x_range ) / ( 2.0 * x_range ) z_norm = ( z + z_range ) / ( 2.0 * z_range ) x_idx = torch . clamp (( x_norm * bev_width ) . long (), 0 , bev_width - 1 ) z_idx = torch . clamp (( z_norm * bev_height ) . long (), 0 , bev_height - 1 ) # \u7528 index_put_ \u7d2f\u52a0\uff08\u6bd4 Python for \u5feb\u5f88\u591a\uff09 bev = bev_maps [ i , 0 ] bev . index_put_ (( z_idx , x_idx ), torch . ones_like ( x_idx , dtype = bev . dtype ), accumulate = True ) return bev_maps FarawayFrustumBoxRegression \u00b6 FarawayFrustumBoxRegression \u00b6 Bases: Module FarawayFrustumBoxRegression \u6a21\u5757\uff08Faraway-Frustum \u8fdc\u8ddd\u79bb\u56de\u5f52\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a\u8fdc\u8ddd\u79bb\u76ee\u6807\u7684 BEV \u6295\u5f71\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c \u7528\u4e8e\u5728\u7a00\u758f\u70b9\u4e91\u6761\u4ef6\u4e0b\u56de\u5f52 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u5176\u672c\u8d28\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u5377\u79ef\u7f51\u7edc\uff0c\u901a\u8fc7\u591a\u5c42\u5377\u79ef\u4e0e\u5168\u8fde\u63a5\u5c42\uff0c \u5b66\u4e60 BEV \u7a7a\u95f4\u4e2d\u76ee\u6807\u7684\u6df1\u5ea6\u4fee\u6b63\u91cf\u3001\u5c3a\u5bf8\u4ee5\u53ca\u671d\u5411\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e \u53ef\u5b66\u4e60\u7b97\u5b50 \uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002 \u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09 \u00b6 Conv2d 1 \u2192 16, kernel=3, padding=1 \u5bf9 BEV \u5355\u901a\u9053\u8f93\u5165\u8fdb\u884c\u521d\u6b65\u7a7a\u95f4\u7279\u5f81\u63d0\u53d6\u3002 ReLU \u6fc0\u6d3b Conv2d 16 \u2192 32, kernel=3, padding=1 \u589e\u5f3a\u7a7a\u95f4\u8bed\u4e49\u8868\u8fbe\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b AdaptiveAvgPool2d \u2192 (1, 1) \u5c06\u7a7a\u95f4\u7279\u5f81\u538b\u7f29\u4e3a\u5168\u5c40\u7279\u5f81\u5411\u91cf\u3002 Flatten \u5c55\u5e73\u4e3a\u4e00\u7ef4\u5411\u91cf\u3002 Linear 32 \u2192 64 \u975e\u7ebf\u6027\u6620\u5c04\uff0c\u63d0\u9ad8\u56de\u5f52\u8868\u8fbe\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b Linear 64 \u2192 5 \u8f93\u51fa\u56de\u5f52\u53c2\u6570\uff1a (\u0394z, w, l, h, \u03b1) \u8f93\u5165 \u00b6 Parameters: bev_features ( Tensor ) \u2013 BEV \u6295\u5f71\u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a (B, 1, H, W) - B\uff1abatch size - 1\uff1a\u5355\u901a\u9053 BEV \u5bc6\u5ea6\u56fe - H, W\uff1aBEV \u7a7a\u95f4\u5206\u8fa8\u7387 \u8f93\u51fa \u00b6 Returns: \u2013 torch.Tensor: \u56de\u5f52\u7ed3\u679c\u5f20\u91cf\uff0cshape\uff1a (B, 5) - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u76ee\u6807\u5bbd\u5ea6 - l\uff1a\u76ee\u6807\u957f\u5ea6 - h\uff1a\u76ee\u6807\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2 \u6a21\u5757\u7528\u9014 \u00b6 \u9488\u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u8f7b\u91cf\u7ea7 3D \u8fb9\u754c\u6846\u56de\u5f52 \u5728\u70b9\u4e91\u7a00\u758f\u6761\u4ef6\u4e0b\u907f\u514d\u590d\u6742\u70b9\u4e91\u7279\u5f81\u5b66\u4e60 \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aFaraway Box Refinement \u6838\u5fc3\u90e8\u5206 Source code in Faraway_Refinement\\network\\FarawayFrustumBoxRegression.py 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 class FarawayFrustumBoxRegression ( nn . Module ): \"\"\" FarawayFrustumBoxRegression \u6a21\u5757\uff08Faraway-Frustum \u8fdc\u8ddd\u79bb\u56de\u5f52\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a\u8fdc\u8ddd\u79bb\u76ee\u6807\u7684 BEV \u6295\u5f71\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c \u7528\u4e8e\u5728\u7a00\u758f\u70b9\u4e91\u6761\u4ef6\u4e0b\u56de\u5f52 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u5176\u672c\u8d28\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u5377\u79ef\u7f51\u7edc\uff0c\u901a\u8fc7\u591a\u5c42\u5377\u79ef\u4e0e\u5168\u8fde\u63a5\u5c42\uff0c \u5b66\u4e60 BEV \u7a7a\u95f4\u4e2d\u76ee\u6807\u7684\u6df1\u5ea6\u4fee\u6b63\u91cf\u3001\u5c3a\u5bf8\u4ee5\u53ca\u671d\u5411\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e **\u53ef\u5b66\u4e60\u7b97\u5b50**\uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002 --- ### \u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09 1. **Conv2d 1 \u2192 16, kernel=3, padding=1** - \u5bf9 BEV \u5355\u901a\u9053\u8f93\u5165\u8fdb\u884c\u521d\u6b65\u7a7a\u95f4\u7279\u5f81\u63d0\u53d6\u3002 2. **ReLU \u6fc0\u6d3b** 3. **Conv2d 16 \u2192 32, kernel=3, padding=1** - \u589e\u5f3a\u7a7a\u95f4\u8bed\u4e49\u8868\u8fbe\u80fd\u529b\u3002 4. **ReLU \u6fc0\u6d3b** 5. **AdaptiveAvgPool2d \u2192 (1, 1)** - \u5c06\u7a7a\u95f4\u7279\u5f81\u538b\u7f29\u4e3a\u5168\u5c40\u7279\u5f81\u5411\u91cf\u3002 6. **Flatten** - \u5c55\u5e73\u4e3a\u4e00\u7ef4\u5411\u91cf\u3002 7. **Linear 32 \u2192 64** - \u975e\u7ebf\u6027\u6620\u5c04\uff0c\u63d0\u9ad8\u56de\u5f52\u8868\u8fbe\u80fd\u529b\u3002 8. **ReLU \u6fc0\u6d3b** 9. **Linear 64 \u2192 5** - \u8f93\u51fa\u56de\u5f52\u53c2\u6570\uff1a (\u0394z, w, l, h, \u03b1) --- ### \u8f93\u5165 Args: bev_features (torch.Tensor): BEV \u6295\u5f71\u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a **(B, 1, H, W)** - B\uff1abatch size - 1\uff1a\u5355\u901a\u9053 BEV \u5bc6\u5ea6\u56fe - H, W\uff1aBEV \u7a7a\u95f4\u5206\u8fa8\u7387 --- ### \u8f93\u51fa Returns: torch.Tensor: \u56de\u5f52\u7ed3\u679c\u5f20\u91cf\uff0cshape\uff1a**(B, 5)** - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u76ee\u6807\u5bbd\u5ea6 - l\uff1a\u76ee\u6807\u957f\u5ea6 - h\uff1a\u76ee\u6807\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2 --- ### \u6a21\u5757\u7528\u9014 - \u9488\u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u8f7b\u91cf\u7ea7 3D \u8fb9\u754c\u6846\u56de\u5f52 - \u5728\u70b9\u4e91\u7a00\u758f\u6761\u4ef6\u4e0b\u907f\u514d\u590d\u6742\u70b9\u4e91\u7279\u5f81\u5b66\u4e60 - \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aFaraway Box Refinement \u6838\u5fc3\u90e8\u5206 \"\"\" def __init__ ( self ): super ( FarawayFrustumBoxRegression , self ) . __init__ () self . conv1 = nn . Conv2d ( 1 , 16 , kernel_size = 3 , padding = 1 ) self . relu1 = nn . ReLU ( inplace = True ) self . conv2 = nn . Conv2d ( 16 , 32 , kernel_size = 3 , padding = 1 ) self . relu2 = nn . ReLU ( inplace = True ) self . pool = nn . AdaptiveAvgPool2d (( 1 , 1 )) self . fc1 = nn . Linear ( 32 , 64 ) self . relu3 = nn . ReLU ( inplace = True ) self . fc2 = nn . Linear ( 64 , 5 ) def forward ( self , bev_features : torch . Tensor ) -> torch . Tensor : x = self . conv1 ( bev_features ) x = self . relu1 ( x ) x = self . conv2 ( x ) x = self . relu2 ( x ) x = self . pool ( x ) x = torch . flatten ( x , 1 ) x = self . fc1 ( x ) x = self . relu3 ( x ) x = self . fc2 ( x ) return x assemble_faraway_3d_box \u00b6 assemble_faraway_3d_box ( centroids , regression_outputs ) \u00b6 \u8fdc\u8ddd\u79bb 3D \u8fb9\u754c\u6846\u7ec4\u88c5\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u51e0\u4f55\u9636\u6bb5\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5e73\u9762\u4f4d\u7f6e (x, y) \u4e0e FarawayFrustumBoxRegression \u7f51\u7edc\u8f93\u51fa\u7684\u56de\u5f52\u7ed3\u679c\u8fdb\u884c\u878d\u5408\uff0c \u751f\u6210\u6700\u7ec8\u7684 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u8be5\u7b97\u5b50\u4e0d\u5305\u542b\u53ef\u5b66\u4e60\u53c2\u6570\uff0c\u4ec5\u8d1f\u8d23\u6570\u636e\u62fc\u63a5\u4e0e\u7ed3\u6784\u7ec4\u88c5\uff0c \u5c5e\u4e8e Faraway-Frustum \u7684\u7ed3\u679c\u751f\u6210\u9636\u6bb5\u3002 \u8f93\u5165 \u00b6 Parameters: centroids ( Tensor ) \u2013 \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\uff0cshape \u4e3a (B, 3) - B\uff1a\u5b9e\u4f8b\u6570\u91cf - 3\uff1a(x, y, z) regression_outputs ( Tensor ) \u2013 \u7f51\u7edc\u56de\u5f52\u8f93\u51fa\uff0cshape \u4e3a (B, 5) - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u5bbd\u5ea6 - l\uff1a\u957f\u5ea6 - h\uff1a\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2 \u8f93\u51fa \u00b6 Returns: Tensor \u2013 torch.Tensor: \u6700\u7ec8 3D \u8fb9\u754c\u6846\uff0cshape\uff1a (B, 7) \u683c\u5f0f\u4e3a\uff1a (x, y, z_refined, w, l, h, \u03b1) \u7b97\u5b50\u7528\u9014 \u00b6 \u5c06\u51e0\u4f55\u5b9a\u4f4d\u7ed3\u679c\u4e0e\u5b66\u4e60\u56de\u5f52\u7ed3\u679c\u878d\u5408 \u8f93\u51fa\u6807\u51c6\u683c\u5f0f\u7684 3D \u8fb9\u754c\u6846 \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aBox Assembly \u9636\u6bb5 Source code in Faraway_Refinement\\operator\\assemble_faraway_3d_box.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 @torch . library . custom_op ( \"faraway::assemble_faraway_3d_box\" , mutates_args = []) def assemble_faraway_3d_box ( centroids : torch . Tensor , regression_outputs : torch . Tensor , ) -> torch . Tensor : \"\"\" \u8fdc\u8ddd\u79bb 3D \u8fb9\u754c\u6846\u7ec4\u88c5\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u51e0\u4f55\u9636\u6bb5\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5e73\u9762\u4f4d\u7f6e (x, y) \u4e0e FarawayFrustumBoxRegression \u7f51\u7edc\u8f93\u51fa\u7684\u56de\u5f52\u7ed3\u679c\u8fdb\u884c\u878d\u5408\uff0c \u751f\u6210\u6700\u7ec8\u7684 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u8be5\u7b97\u5b50\u4e0d\u5305\u542b\u53ef\u5b66\u4e60\u53c2\u6570\uff0c\u4ec5\u8d1f\u8d23\u6570\u636e\u62fc\u63a5\u4e0e\u7ed3\u6784\u7ec4\u88c5\uff0c \u5c5e\u4e8e Faraway-Frustum \u7684\u7ed3\u679c\u751f\u6210\u9636\u6bb5\u3002 --- ### \u8f93\u5165 Args: centroids (torch.Tensor): \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\uff0cshape \u4e3a **(B, 3)** - B\uff1a\u5b9e\u4f8b\u6570\u91cf - 3\uff1a(x, y, z) regression_outputs (torch.Tensor): \u7f51\u7edc\u56de\u5f52\u8f93\u51fa\uff0cshape \u4e3a **(B, 5)** - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u5bbd\u5ea6 - l\uff1a\u957f\u5ea6 - h\uff1a\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2 --- ### \u8f93\u51fa Returns: torch.Tensor: \u6700\u7ec8 3D \u8fb9\u754c\u6846\uff0cshape\uff1a**(B, 7)** \u683c\u5f0f\u4e3a\uff1a (x, y, z_refined, w, l, h, \u03b1) --- ### \u7b97\u5b50\u7528\u9014 - \u5c06\u51e0\u4f55\u5b9a\u4f4d\u7ed3\u679c\u4e0e\u5b66\u4e60\u56de\u5f52\u7ed3\u679c\u878d\u5408 - \u8f93\u51fa\u6807\u51c6\u683c\u5f0f\u7684 3D \u8fb9\u754c\u6846 - \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aBox Assembly \u9636\u6bb5 \"\"\" x = centroids [:, 0 ] y = centroids [:, 1 ] z = centroids [:, 2 ] delta_z = regression_outputs [:, 0 ] w = regression_outputs [:, 1 ] l = regression_outputs [:, 2 ] h = regression_outputs [:, 3 ] alpha = regression_outputs [:, 4 ] z_refined = z + delta_z boxes_3d = torch . stack ([ x , y , z_refined , w , l , h , alpha ], dim = 1 ) return boxes_3d","title":"Faraway \u7ec6\u5316\u9636\u6bb5 (Faraway Refinement)"},{"location":"Faraway_Refinement/#stage-2-faraway-refinementfaraway","text":"\ud83d\udca1 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u51e0\u4f55\u5bf9\u9f50\u3001\u5c40\u90e8\u5750\u6807\u5f52\u4e00\u5316\u4e0e BEV \u8868\u793a\u6784\u5efa\uff0c\u5e76\u901a\u8fc7\u53ef\u5b66\u4e60\u7f51\u7edc\u56de\u5f52\u6700\u7ec8 3D \u6846\u53c2\u6570 \uff0c \u4ece\u800c\u63d0\u5347\u8fdc\u8ddd\u79bb\u76ee\u6807\u7684\u5b9a\u4f4d\u7cbe\u5ea6\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e94\u4e2a\u7b97\u5b50\uff1a frustum_axis_alignment \u5bf9 Frustum \u70b9\u4e91\u8fdb\u884c\u5750\u6807\u65cb\u8f6c\uff0c\u4f7f\u5176\u4e0e\u76ee\u6807\u4e3b\u65b9\u5411\u5bf9\u9f50\u3002 centroid_coordinate_transform \u5c06\u70b9\u4e91\u8f6c\u6362\u5230\u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u7cfb\u3002 frustum_bev_projection \u5c06\u5c40\u90e8\u70b9\u4e91\u6295\u5f71\u4e3a BEV \u8868\u793a\uff0c\u7528\u4e8e\u540e\u7eed\u7f51\u7edc\u56de\u5f52\u3002 FarawayFrustumBoxRegression \u57fa\u4e8e BEV \u7279\u5f81\u8fdb\u884c 3D Box \u53c2\u6570\u56de\u5f52\u7684\u53ef\u5b66\u4e60\u7f51\u7edc\uff08FF-Net\uff09\u3002 assemble_faraway_3d_box \u6839\u636e\u8d28\u5fc3\u4e0e\u56de\u5f52\u7ed3\u679c\u7ec4\u88c5\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u6846\u3002","title":"Stage 2 \u2013 Faraway Refinement\uff08Faraway \u7ec6\u5316\u9636\u6bb5\uff09"},{"location":"Faraway_Refinement/#api","text":"","title":"API \u6587\u6863"},{"location":"Faraway_Refinement/#frustum_axis_alignment","text":"","title":"frustum_axis_alignment"},{"location":"Faraway_Refinement/#Faraway_Refinement.operator.frustum_axis_alignment.frustum_axis_alignment","text":"Frustum \u5750\u6807\u8f74\u5bf9\u9f50\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u6839\u636e\u5176\u5bf9\u5e94\u7684\u89c6\u9525\u65b9\u5411\u89d2\u8fdb\u884c\u65cb\u8f6c\uff0c \u7edf\u4e00\u5bf9\u9f50\u5230\u6807\u51c6\u5750\u6807\u7cfb\u65b9\u5411\uff0c\u4ece\u800c\u6d88\u9664\u76f8\u673a\u89c6\u89d2\u5e26\u6765\u7684\u65b9\u5411\u5dee\u5f02\uff0c \u4e3a\u540e\u7eed\u8d28\u5fc3\u5e73\u79fb\u4e0e BEV \u6295\u5f71\u63d0\u4f9b\u7a33\u5b9a\u8f93\u5165\u3002 Parameters: frustum_clusters \u2013 List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 frustum_angles ( Tensor ) \u2013 (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u671d\u5411\u89d2\uff08\u7ed5 Y \u8f74\u65cb\u8f6c\u89d2\u5ea6\uff0c\u5355\u4f4d\uff1a\u5f27\u5ea6\uff09\u3002 Returns: aligned_clusters ( Tensor ) \u2013 List[(Ni, 3)] \u65cb\u8f6c\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\u3002 Source code in Faraway_Refinement\\operator\\frustum_axis_alignment.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @torch . library . custom_op ( \"faraway::frustum_axis_alignment\" , mutates_args = []) def frustum_axis_alignment ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) frustum_angles : torch . Tensor , # (K,) ) -> torch . Tensor : \"\"\" Frustum \u5750\u6807\u8f74\u5bf9\u9f50\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u6839\u636e\u5176\u5bf9\u5e94\u7684\u89c6\u9525\u65b9\u5411\u89d2\u8fdb\u884c\u65cb\u8f6c\uff0c \u7edf\u4e00\u5bf9\u9f50\u5230\u6807\u51c6\u5750\u6807\u7cfb\u65b9\u5411\uff0c\u4ece\u800c\u6d88\u9664\u76f8\u673a\u89c6\u89d2\u5e26\u6765\u7684\u65b9\u5411\u5dee\u5f02\uff0c \u4e3a\u540e\u7eed\u8d28\u5fc3\u5e73\u79fb\u4e0e BEV \u6295\u5f71\u63d0\u4f9b\u7a33\u5b9a\u8f93\u5165\u3002 Args: frustum_clusters: List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 frustum_angles: (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u671d\u5411\u89d2\uff08\u7ed5 Y \u8f74\u65cb\u8f6c\u89d2\u5ea6\uff0c\u5355\u4f4d\uff1a\u5f27\u5ea6\uff09\u3002 Returns: aligned_clusters: List[(Ni, 3)] \u65cb\u8f6c\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\u3002 \"\"\" device = clusters . device aligned = torch . zeros_like ( clusters ) K = int ( clusters . shape [ 0 ]) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue theta = frustum_angles [ i ] c = torch . cos ( theta ) s = torch . sin ( theta ) rot = torch . stack ([ torch . stack ([ c , torch . tensor ( 0.0 , device = device ), s ]), torch . stack ([ torch . tensor ( 0.0 , device = device ), torch . tensor ( 1.0 , device = device ), torch . tensor ( 0.0 , device = device )]), torch . stack ([ - s , torch . tensor ( 0.0 , device = device ), c ]), ], dim = 0 ) . to ( clusters . dtype ) # (3,3) pts = clusters [ i , : n , :] # (n,3) aligned [ i , : n , :] = pts @ rot . T return aligned","title":"frustum_axis_alignment"},{"location":"Faraway_Refinement/#centroid_coordinate_transform","text":"","title":"centroid_coordinate_transform"},{"location":"Faraway_Refinement/#Faraway_Refinement.operator.centroid_coordinate_transform.centroid_coordinate_transform","text":"\u8d28\u5fc3\u5750\u6807\u5f52\u4e00\u5316\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u5e73\u79fb\u5230\u4ee5\u76ee\u6807\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u7cfb\uff0c \u5373\u5bf9\u70b9\u4e91\u4e2d\u7684\u6bcf\u4e2a\u70b9\u51cf\u53bb\u5bf9\u5e94\u5b9e\u4f8b\u7684\u8d28\u5fc3\u5750\u6807\u3002 \u901a\u8fc7\u8be5\u53d8\u6362\uff0c\u5c06\u5168\u5c40\u5b9a\u4f4d\u95ee\u9898\u8f6c\u6362\u4e3a\u5c40\u90e8\u7ed3\u6784\u5efa\u6a21\u95ee\u9898\uff0c \u6709\u5229\u4e8e\u540e\u7eed BEV \u6295\u5f71\u4e0e\u8f7b\u91cf\u7f51\u7edc\u56de\u5f52\u3002 Parameters: aligned_clusters \u2013 List[(Ni, 3)] \u7ecf\u8fc7\u65b9\u5411\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 centroids ( Tensor ) \u2013 (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 Returns: local_clusters ( Tensor ) \u2013 List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u70b9\u4e91\u96c6\u5408\u3002 Source code in Faraway_Refinement\\operator\\centroid_coordinate_transform.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 @torch . library . custom_op ( \"faraway::centroid_coordinate_transform\" , mutates_args = []) def centroid_coordinate_transform ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) centroids : torch . Tensor , # (K, 3) ) -> torch . Tensor : \"\"\" \u8d28\u5fc3\u5750\u6807\u5f52\u4e00\u5316\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a Frustum \u70b9\u4e91\u5e73\u79fb\u5230\u4ee5\u76ee\u6807\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u7cfb\uff0c \u5373\u5bf9\u70b9\u4e91\u4e2d\u7684\u6bcf\u4e2a\u70b9\u51cf\u53bb\u5bf9\u5e94\u5b9e\u4f8b\u7684\u8d28\u5fc3\u5750\u6807\u3002 \u901a\u8fc7\u8be5\u53d8\u6362\uff0c\u5c06\u5168\u5c40\u5b9a\u4f4d\u95ee\u9898\u8f6c\u6362\u4e3a\u5c40\u90e8\u7ed3\u6784\u5efa\u6a21\u95ee\u9898\uff0c \u6709\u5229\u4e8e\u540e\u7eed BEV \u6295\u5f71\u4e0e\u8f7b\u91cf\u7f51\u7edc\u56de\u5f52\u3002 Args: aligned_clusters: List[(Ni, 3)] \u7ecf\u8fc7\u65b9\u5411\u5bf9\u9f50\u540e\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 centroids: (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 Returns: local_clusters: List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u5750\u6807\u70b9\u4e91\u96c6\u5408\u3002 \"\"\" local = torch . zeros_like ( clusters ) K = int ( clusters . shape [ 0 ]) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue local [ i , : n , :] = clusters [ i , : n , :] - centroids [ i ] . unsqueeze ( 0 ) return local","title":"centroid_coordinate_transform"},{"location":"Faraway_Refinement/#frustum_bev_projection","text":"","title":"frustum_bev_projection"},{"location":"Faraway_Refinement/#Faraway_Refinement.operator.frustum_bev_projection.frustum_bev_projection","text":"Frustum \u70b9\u4e91 BEV \u6295\u5f71\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a\u5b9e\u4f8b\u5728\u5c40\u90e8\u5750\u6807\u7cfb\u4e0b\u7684\u4e09\u7ef4\u70b9\u4e91 \u6295\u5f71\u5230 Bird's Eye View (BEV) \u5e73\u9762\uff0c \u751f\u6210\u56fa\u5b9a\u5c3a\u5bf8\u7684\u4e8c\u7ef4\u6805\u683c\u8868\u793a\uff0c\u7528\u4e8e\u540e\u7eed\u8f7b\u91cf\u56de\u5f52\u7f51\u7edc\u8f93\u5165\u3002 \u6295\u5f71\u65b9\u5f0f\uff1a - \u4f7f\u7528 (x, z) \u5e73\u9762\u6784\u5efa BEV - \u7edf\u8ba1\u6bcf\u4e2a\u6805\u683c\u4e2d\u7684\u70b9\u6570\u4f5c\u4e3a\u5f3a\u5ea6\u503c Parameters: local_clusters \u2013 List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u70b9\u4e91\u96c6\u5408\u3002 bev_height ( int ) \u2013 int BEV \u6805\u683c\u9ad8\u5ea6\u3002 bev_width ( int ) \u2013 int BEV \u6805\u683c\u5bbd\u5ea6\u3002 x_range ( float ) \u2013 float BEV \u5728 x \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-x_range, x_range]\uff09\u3002 z_range ( float ) \u2013 float BEV \u5728 z \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-z_range, z_range]\uff09\u3002 Returns: bev_maps ( Tensor ) \u2013 (K, 1, H, W) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 BEV \u6295\u5f71\u7ed3\u679c\uff0c \u5355\u901a\u9053\u8868\u793a\u70b9\u6570\u5bc6\u5ea6\u3002 Source code in Faraway_Refinement\\operator\\frustum_bev_projection.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 @torch . library . custom_op ( \"faraway::frustum_bev_projection\" , mutates_args = []) def frustum_bev_projection ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) bev_height : int , bev_width : int , x_range : float , z_range : float , ) -> torch . Tensor : \"\"\" Frustum \u70b9\u4e91 BEV \u6295\u5f71\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u6bcf\u4e2a\u5b9e\u4f8b\u5728\u5c40\u90e8\u5750\u6807\u7cfb\u4e0b\u7684\u4e09\u7ef4\u70b9\u4e91 \u6295\u5f71\u5230 Bird's Eye View (BEV) \u5e73\u9762\uff0c \u751f\u6210\u56fa\u5b9a\u5c3a\u5bf8\u7684\u4e8c\u7ef4\u6805\u683c\u8868\u793a\uff0c\u7528\u4e8e\u540e\u7eed\u8f7b\u91cf\u56de\u5f52\u7f51\u7edc\u8f93\u5165\u3002 \u6295\u5f71\u65b9\u5f0f\uff1a - \u4f7f\u7528 (x, z) \u5e73\u9762\u6784\u5efa BEV - \u7edf\u8ba1\u6bcf\u4e2a\u6805\u683c\u4e2d\u7684\u70b9\u6570\u4f5c\u4e3a\u5f3a\u5ea6\u503c Args: local_clusters: List[(Ni, 3)] \u4ee5\u8d28\u5fc3\u4e3a\u539f\u70b9\u7684\u5c40\u90e8\u70b9\u4e91\u96c6\u5408\u3002 bev_height: int BEV \u6805\u683c\u9ad8\u5ea6\u3002 bev_width: int BEV \u6805\u683c\u5bbd\u5ea6\u3002 x_range: float BEV \u5728 x \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-x_range, x_range]\uff09\u3002 z_range: float BEV \u5728 z \u65b9\u5411\u7684\u6700\u5927\u8986\u76d6\u8303\u56f4\uff08[-z_range, z_range]\uff09\u3002 Returns: bev_maps: (K, 1, H, W) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 BEV \u6295\u5f71\u7ed3\u679c\uff0c \u5355\u901a\u9053\u8868\u793a\u70b9\u6570\u5bc6\u5ea6\u3002 \"\"\" device = clusters . device K = int ( clusters . shape [ 0 ]) bev_maps = torch . zeros (( K , 1 , bev_height , bev_width ), device = device , dtype = clusters . dtype ) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue pts = clusters [ i , : n , :] x = pts [:, 0 ] z = pts [:, 2 ] x_norm = ( x + x_range ) / ( 2.0 * x_range ) z_norm = ( z + z_range ) / ( 2.0 * z_range ) x_idx = torch . clamp (( x_norm * bev_width ) . long (), 0 , bev_width - 1 ) z_idx = torch . clamp (( z_norm * bev_height ) . long (), 0 , bev_height - 1 ) # \u7528 index_put_ \u7d2f\u52a0\uff08\u6bd4 Python for \u5feb\u5f88\u591a\uff09 bev = bev_maps [ i , 0 ] bev . index_put_ (( z_idx , x_idx ), torch . ones_like ( x_idx , dtype = bev . dtype ), accumulate = True ) return bev_maps","title":"frustum_bev_projection"},{"location":"Faraway_Refinement/#farawayfrustumboxregression","text":"","title":"FarawayFrustumBoxRegression"},{"location":"Faraway_Refinement/#Faraway_Refinement.network.FarawayFrustumBoxRegression.FarawayFrustumBoxRegression","text":"Bases: Module FarawayFrustumBoxRegression \u6a21\u5757\uff08Faraway-Frustum \u8fdc\u8ddd\u79bb\u56de\u5f52\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a\u8fdc\u8ddd\u79bb\u76ee\u6807\u7684 BEV \u6295\u5f71\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c \u7528\u4e8e\u5728\u7a00\u758f\u70b9\u4e91\u6761\u4ef6\u4e0b\u56de\u5f52 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u5176\u672c\u8d28\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u5377\u79ef\u7f51\u7edc\uff0c\u901a\u8fc7\u591a\u5c42\u5377\u79ef\u4e0e\u5168\u8fde\u63a5\u5c42\uff0c \u5b66\u4e60 BEV \u7a7a\u95f4\u4e2d\u76ee\u6807\u7684\u6df1\u5ea6\u4fee\u6b63\u91cf\u3001\u5c3a\u5bf8\u4ee5\u53ca\u671d\u5411\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e \u53ef\u5b66\u4e60\u7b97\u5b50 \uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002","title":"FarawayFrustumBoxRegression"},{"location":"Faraway_Refinement/#Faraway_Refinement.network.FarawayFrustumBoxRegression.FarawayFrustumBoxRegression--_1","text":"Conv2d 1 \u2192 16, kernel=3, padding=1 \u5bf9 BEV \u5355\u901a\u9053\u8f93\u5165\u8fdb\u884c\u521d\u6b65\u7a7a\u95f4\u7279\u5f81\u63d0\u53d6\u3002 ReLU \u6fc0\u6d3b Conv2d 16 \u2192 32, kernel=3, padding=1 \u589e\u5f3a\u7a7a\u95f4\u8bed\u4e49\u8868\u8fbe\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b AdaptiveAvgPool2d \u2192 (1, 1) \u5c06\u7a7a\u95f4\u7279\u5f81\u538b\u7f29\u4e3a\u5168\u5c40\u7279\u5f81\u5411\u91cf\u3002 Flatten \u5c55\u5e73\u4e3a\u4e00\u7ef4\u5411\u91cf\u3002 Linear 32 \u2192 64 \u975e\u7ebf\u6027\u6620\u5c04\uff0c\u63d0\u9ad8\u56de\u5f52\u8868\u8fbe\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b Linear 64 \u2192 5 \u8f93\u51fa\u56de\u5f52\u53c2\u6570\uff1a (\u0394z, w, l, h, \u03b1)","title":"\u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09"},{"location":"Faraway_Refinement/#Faraway_Refinement.network.FarawayFrustumBoxRegression.FarawayFrustumBoxRegression--_2","text":"Parameters: bev_features ( Tensor ) \u2013 BEV \u6295\u5f71\u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a (B, 1, H, W) - B\uff1abatch size - 1\uff1a\u5355\u901a\u9053 BEV \u5bc6\u5ea6\u56fe - H, W\uff1aBEV \u7a7a\u95f4\u5206\u8fa8\u7387","title":"\u8f93\u5165"},{"location":"Faraway_Refinement/#Faraway_Refinement.network.FarawayFrustumBoxRegression.FarawayFrustumBoxRegression--_1","text":"Returns: \u2013 torch.Tensor: \u56de\u5f52\u7ed3\u679c\u5f20\u91cf\uff0cshape\uff1a (B, 5) - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u76ee\u6807\u5bbd\u5ea6 - l\uff1a\u76ee\u6807\u957f\u5ea6 - h\uff1a\u76ee\u6807\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2","title":"\u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09"},{"location":"Faraway_Refinement/#Faraway_Refinement.network.FarawayFrustumBoxRegression.FarawayFrustumBoxRegression--_1","text":"\u9488\u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u8f7b\u91cf\u7ea7 3D \u8fb9\u754c\u6846\u56de\u5f52 \u5728\u70b9\u4e91\u7a00\u758f\u6761\u4ef6\u4e0b\u907f\u514d\u590d\u6742\u70b9\u4e91\u7279\u5f81\u5b66\u4e60 \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aFaraway Box Refinement \u6838\u5fc3\u90e8\u5206 Source code in Faraway_Refinement\\network\\FarawayFrustumBoxRegression.py 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 class FarawayFrustumBoxRegression ( nn . Module ): \"\"\" FarawayFrustumBoxRegression \u6a21\u5757\uff08Faraway-Frustum \u8fdc\u8ddd\u79bb\u56de\u5f52\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a\u8fdc\u8ddd\u79bb\u76ee\u6807\u7684 BEV \u6295\u5f71\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c \u7528\u4e8e\u5728\u7a00\u758f\u70b9\u4e91\u6761\u4ef6\u4e0b\u56de\u5f52 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u5176\u672c\u8d28\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u5377\u79ef\u7f51\u7edc\uff0c\u901a\u8fc7\u591a\u5c42\u5377\u79ef\u4e0e\u5168\u8fde\u63a5\u5c42\uff0c \u5b66\u4e60 BEV \u7a7a\u95f4\u4e2d\u76ee\u6807\u7684\u6df1\u5ea6\u4fee\u6b63\u91cf\u3001\u5c3a\u5bf8\u4ee5\u53ca\u671d\u5411\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e **\u53ef\u5b66\u4e60\u7b97\u5b50**\uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002 --- ### \u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09 1. **Conv2d 1 \u2192 16, kernel=3, padding=1** - \u5bf9 BEV \u5355\u901a\u9053\u8f93\u5165\u8fdb\u884c\u521d\u6b65\u7a7a\u95f4\u7279\u5f81\u63d0\u53d6\u3002 2. **ReLU \u6fc0\u6d3b** 3. **Conv2d 16 \u2192 32, kernel=3, padding=1** - \u589e\u5f3a\u7a7a\u95f4\u8bed\u4e49\u8868\u8fbe\u80fd\u529b\u3002 4. **ReLU \u6fc0\u6d3b** 5. **AdaptiveAvgPool2d \u2192 (1, 1)** - \u5c06\u7a7a\u95f4\u7279\u5f81\u538b\u7f29\u4e3a\u5168\u5c40\u7279\u5f81\u5411\u91cf\u3002 6. **Flatten** - \u5c55\u5e73\u4e3a\u4e00\u7ef4\u5411\u91cf\u3002 7. **Linear 32 \u2192 64** - \u975e\u7ebf\u6027\u6620\u5c04\uff0c\u63d0\u9ad8\u56de\u5f52\u8868\u8fbe\u80fd\u529b\u3002 8. **ReLU \u6fc0\u6d3b** 9. **Linear 64 \u2192 5** - \u8f93\u51fa\u56de\u5f52\u53c2\u6570\uff1a (\u0394z, w, l, h, \u03b1) --- ### \u8f93\u5165 Args: bev_features (torch.Tensor): BEV \u6295\u5f71\u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a **(B, 1, H, W)** - B\uff1abatch size - 1\uff1a\u5355\u901a\u9053 BEV \u5bc6\u5ea6\u56fe - H, W\uff1aBEV \u7a7a\u95f4\u5206\u8fa8\u7387 --- ### \u8f93\u51fa Returns: torch.Tensor: \u56de\u5f52\u7ed3\u679c\u5f20\u91cf\uff0cshape\uff1a**(B, 5)** - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u76ee\u6807\u5bbd\u5ea6 - l\uff1a\u76ee\u6807\u957f\u5ea6 - h\uff1a\u76ee\u6807\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2 --- ### \u6a21\u5757\u7528\u9014 - \u9488\u5bf9\u8fdc\u8ddd\u79bb\u76ee\u6807\u8fdb\u884c\u8f7b\u91cf\u7ea7 3D \u8fb9\u754c\u6846\u56de\u5f52 - \u5728\u70b9\u4e91\u7a00\u758f\u6761\u4ef6\u4e0b\u907f\u514d\u590d\u6742\u70b9\u4e91\u7279\u5f81\u5b66\u4e60 - \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aFaraway Box Refinement \u6838\u5fc3\u90e8\u5206 \"\"\" def __init__ ( self ): super ( FarawayFrustumBoxRegression , self ) . __init__ () self . conv1 = nn . Conv2d ( 1 , 16 , kernel_size = 3 , padding = 1 ) self . relu1 = nn . ReLU ( inplace = True ) self . conv2 = nn . Conv2d ( 16 , 32 , kernel_size = 3 , padding = 1 ) self . relu2 = nn . ReLU ( inplace = True ) self . pool = nn . AdaptiveAvgPool2d (( 1 , 1 )) self . fc1 = nn . Linear ( 32 , 64 ) self . relu3 = nn . ReLU ( inplace = True ) self . fc2 = nn . Linear ( 64 , 5 ) def forward ( self , bev_features : torch . Tensor ) -> torch . Tensor : x = self . conv1 ( bev_features ) x = self . relu1 ( x ) x = self . conv2 ( x ) x = self . relu2 ( x ) x = self . pool ( x ) x = torch . flatten ( x , 1 ) x = self . fc1 ( x ) x = self . relu3 ( x ) x = self . fc2 ( x ) return x","title":"\u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09"},{"location":"Faraway_Refinement/#assemble_faraway_3d_box","text":"","title":"assemble_faraway_3d_box"},{"location":"Faraway_Refinement/#Faraway_Refinement.operator.assemble_faraway_3d_box.assemble_faraway_3d_box","text":"\u8fdc\u8ddd\u79bb 3D \u8fb9\u754c\u6846\u7ec4\u88c5\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u51e0\u4f55\u9636\u6bb5\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5e73\u9762\u4f4d\u7f6e (x, y) \u4e0e FarawayFrustumBoxRegression \u7f51\u7edc\u8f93\u51fa\u7684\u56de\u5f52\u7ed3\u679c\u8fdb\u884c\u878d\u5408\uff0c \u751f\u6210\u6700\u7ec8\u7684 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u8be5\u7b97\u5b50\u4e0d\u5305\u542b\u53ef\u5b66\u4e60\u53c2\u6570\uff0c\u4ec5\u8d1f\u8d23\u6570\u636e\u62fc\u63a5\u4e0e\u7ed3\u6784\u7ec4\u88c5\uff0c \u5c5e\u4e8e Faraway-Frustum \u7684\u7ed3\u679c\u751f\u6210\u9636\u6bb5\u3002","title":"assemble_faraway_3d_box"},{"location":"Faraway_Refinement/#Faraway_Refinement.operator.assemble_faraway_3d_box.assemble_faraway_3d_box--_1","text":"Parameters: centroids ( Tensor ) \u2013 \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\uff0cshape \u4e3a (B, 3) - B\uff1a\u5b9e\u4f8b\u6570\u91cf - 3\uff1a(x, y, z) regression_outputs ( Tensor ) \u2013 \u7f51\u7edc\u56de\u5f52\u8f93\u51fa\uff0cshape \u4e3a (B, 5) - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u5bbd\u5ea6 - l\uff1a\u957f\u5ea6 - h\uff1a\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2","title":"\u8f93\u5165"},{"location":"Faraway_Refinement/#Faraway_Refinement.operator.assemble_faraway_3d_box.assemble_faraway_3d_box--_1","text":"Returns: Tensor \u2013 torch.Tensor: \u6700\u7ec8 3D \u8fb9\u754c\u6846\uff0cshape\uff1a (B, 7) \u683c\u5f0f\u4e3a\uff1a (x, y, z_refined, w, l, h, \u03b1)","title":"\u8f93\u5165"},{"location":"Faraway_Refinement/#Faraway_Refinement.operator.assemble_faraway_3d_box.assemble_faraway_3d_box--_1","text":"\u5c06\u51e0\u4f55\u5b9a\u4f4d\u7ed3\u679c\u4e0e\u5b66\u4e60\u56de\u5f52\u7ed3\u679c\u878d\u5408 \u8f93\u51fa\u6807\u51c6\u683c\u5f0f\u7684 3D \u8fb9\u754c\u6846 \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aBox Assembly \u9636\u6bb5 Source code in Faraway_Refinement\\operator\\assemble_faraway_3d_box.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 @torch . library . custom_op ( \"faraway::assemble_faraway_3d_box\" , mutates_args = []) def assemble_faraway_3d_box ( centroids : torch . Tensor , regression_outputs : torch . Tensor , ) -> torch . Tensor : \"\"\" \u8fdc\u8ddd\u79bb 3D \u8fb9\u754c\u6846\u7ec4\u88c5\u7b97\u5b50\u3002 \u8be5\u7b97\u5b50\u5c06\u51e0\u4f55\u9636\u6bb5\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5e73\u9762\u4f4d\u7f6e (x, y) \u4e0e FarawayFrustumBoxRegression \u7f51\u7edc\u8f93\u51fa\u7684\u56de\u5f52\u7ed3\u679c\u8fdb\u884c\u878d\u5408\uff0c \u751f\u6210\u6700\u7ec8\u7684 3D \u8fb9\u754c\u6846\u53c2\u6570\u3002 \u8be5\u7b97\u5b50\u4e0d\u5305\u542b\u53ef\u5b66\u4e60\u53c2\u6570\uff0c\u4ec5\u8d1f\u8d23\u6570\u636e\u62fc\u63a5\u4e0e\u7ed3\u6784\u7ec4\u88c5\uff0c \u5c5e\u4e8e Faraway-Frustum \u7684\u7ed3\u679c\u751f\u6210\u9636\u6bb5\u3002 --- ### \u8f93\u5165 Args: centroids (torch.Tensor): \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\uff0cshape \u4e3a **(B, 3)** - B\uff1a\u5b9e\u4f8b\u6570\u91cf - 3\uff1a(x, y, z) regression_outputs (torch.Tensor): \u7f51\u7edc\u56de\u5f52\u8f93\u51fa\uff0cshape \u4e3a **(B, 5)** - \u0394z\uff1a\u6df1\u5ea6\u4fee\u6b63\u91cf - w\uff1a\u5bbd\u5ea6 - l\uff1a\u957f\u5ea6 - h\uff1a\u9ad8\u5ea6 - \u03b1\uff1a\u671d\u5411\u89d2 --- ### \u8f93\u51fa Returns: torch.Tensor: \u6700\u7ec8 3D \u8fb9\u754c\u6846\uff0cshape\uff1a**(B, 7)** \u683c\u5f0f\u4e3a\uff1a (x, y, z_refined, w, l, h, \u03b1) --- ### \u7b97\u5b50\u7528\u9014 - \u5c06\u51e0\u4f55\u5b9a\u4f4d\u7ed3\u679c\u4e0e\u5b66\u4e60\u56de\u5f52\u7ed3\u679c\u878d\u5408 - \u8f93\u51fa\u6807\u51c6\u683c\u5f0f\u7684 3D \u8fb9\u754c\u6846 - \u5c5e\u4e8e Faraway-Frustum \u7684 Stage3\uff1aBox Assembly \u9636\u6bb5 \"\"\" x = centroids [:, 0 ] y = centroids [:, 1 ] z = centroids [:, 2 ] delta_z = regression_outputs [:, 0 ] w = regression_outputs [:, 1 ] l = regression_outputs [:, 2 ] h = regression_outputs [:, 3 ] alpha = regression_outputs [:, 4 ] z_refined = z + delta_z boxes_3d = torch . stack ([ x , y , z_refined , w , l , h , alpha ], dim = 1 ) return boxes_3d","title":"\u8f93\u5165"},{"location":"Frustum_Construction/","text":"Stage 1 \u2013 Frustum Construction\uff08Frustum \u6784\u5efa\u9636\u6bb5\uff09 \u00b6 \ud83d\udca1 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u6839\u636e 2D \u5b9e\u4f8b\u4fe1\u606f\u6784\u5efa\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\uff0c\u5e76\u4f30\u8ba1\u76ee\u6807\u8d28\u5fc3\u4e0e\u8fdc\u8fd1\u7c7b\u522b \uff0c \u4e3a\u540e\u7eed Faraway \u7ec6\u5316\u9636\u6bb5\u63d0\u4f9b\u51e0\u4f55\u57fa\u7840\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e09\u4e2a\u7b97\u5b50\uff1a mask_frustum_pointcloud_crop \u6839\u636e 2D mask / box \u88c1\u526a\u70b9\u4e91\uff0c\u751f\u6210\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u7c07\u3002 frustum_histogram_clustering \u5bf9\u6bcf\u4e2a Frustum \u70b9\u4e91\u8fdb\u884c\u76f4\u65b9\u56fe\u7edf\u8ba1\uff0c\u4f30\u8ba1\u76ee\u6807\u8d28\u5fc3\u3002 faraway_object_decision \u6839\u636e\u6df1\u5ea6\u9608\u503c\u5224\u65ad\u76ee\u6807\u5c5e\u4e8e faraway \u8fd8\u662f near\u3002 API \u6587\u6863 \u00b6 mask_frustum_pointcloud_crop \u00b6 mask_frustum_pointcloud_crop ( points_2d_img , points_3d_cam0 , boxes_2d , masks_2d , max_points = 2048 ) \u00b6 \u6839\u636e 2D \u68c0\u6d4b\u7ed3\u679c\u751f\u6210\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5b50\u96c6\u3002 \u8be5\u7b97\u5b50\u5c06 LiDAR \u70b9\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u540e\uff0c \u6839\u636e 2D \u8fb9\u754c\u6846\u6216 2D \u5206\u5272\u63a9\u7801\u7b5b\u9009\u5c5e\u4e8e\u6bcf\u4e2a\u5b9e\u4f8b\u7684 3D \u70b9\uff0c \u6700\u7ec8\u8f93\u51fa\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u3002 Parameters: points_2d_img ( Tensor ) \u2013 (N, 2) \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684 2D \u70b9\u5750\u6807\u3002 points_3d_cam0 ( Tensor ) \u2013 (N, 3) \u5bf9\u5e94\u7684 3D \u70b9\uff08\u76f8\u673a\u5750\u6807\u7cfb\uff09\u3002 boxes_2d ( Tensor ) \u2013 (K, 4) 2D \u68c0\u6d4b\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 masks_2d ( Tensor ) \u2013 (K, H, W) 2D \u5206\u5272\u63a9\u7801\uff0c\u82e5\u4e3a None \u8868\u793a\u4ec5\u4f7f\u7528 2D \u6846\u3002 Returns: frustum_clusters ( Tuple [ Tensor , Tensor ] ) \u2013 (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\uff08\u53d8\u957f\u96c6\u5408\uff0c\u6309\u5b9e\u4f8b\u5212\u5206\uff09\u3002 Source code in Frustum_Construction\\operator\\mask_frustum_pointcloud_crop.py 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 @torch . library . custom_op ( \"faraway::mask_frustum_pointcloud_crop\" , mutates_args = []) def mask_frustum_pointcloud_crop ( points_2d_img : torch . Tensor , # (N, 2) points_3d_cam0 : torch . Tensor , # (N, 3) boxes_2d : torch . Tensor , # (K, 4) masks_2d : torch . Tensor , # (K, H, W) (\u53ef\u4f20\u7a7a Tensor: shape=(0,)) max_points : int = 2048 , ) -> Tuple [ torch . Tensor , torch . Tensor ]: \"\"\" \u6839\u636e 2D \u68c0\u6d4b\u7ed3\u679c\u751f\u6210\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5b50\u96c6\u3002 \u8be5\u7b97\u5b50\u5c06 LiDAR \u70b9\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u540e\uff0c \u6839\u636e 2D \u8fb9\u754c\u6846\u6216 2D \u5206\u5272\u63a9\u7801\u7b5b\u9009\u5c5e\u4e8e\u6bcf\u4e2a\u5b9e\u4f8b\u7684 3D \u70b9\uff0c \u6700\u7ec8\u8f93\u51fa\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u3002 Args: points_2d_img: (N, 2) \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684 2D \u70b9\u5750\u6807\u3002 points_3d_cam0: (N, 3) \u5bf9\u5e94\u7684 3D \u70b9\uff08\u76f8\u673a\u5750\u6807\u7cfb\uff09\u3002 boxes_2d: (K, 4) 2D \u68c0\u6d4b\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 masks_2d: (K, H, W) 2D \u5206\u5272\u63a9\u7801\uff0c\u82e5\u4e3a None \u8868\u793a\u4ec5\u4f7f\u7528 2D \u6846\u3002 Returns: frustum_clusters: (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\uff08\u53d8\u957f\u96c6\u5408\uff0c\u6309\u5b9e\u4f8b\u5212\u5206\uff09\u3002 \"\"\" device = points_3d_cam0 . device K = int ( boxes_2d . shape [ 0 ]) clusters = torch . zeros (( K , max_points , 3 ), device = device , dtype = points_3d_cam0 . dtype ) counts = torch . zeros (( K ,), device = device , dtype = torch . long ) use_mask = ( masks_2d is not None ) and ( masks_2d . numel () > 0 ) for i in range ( K ): if use_mask : mask = masks_2d [ i ] # (H, W) H , W = int ( mask . shape [ 0 ]), int ( mask . shape [ 1 ]) # \u6295\u5f71\u70b9\u53d6\u6574\u5230\u50cf\u7d20\u5750\u6807 x = torch . round ( points_2d_img [:, 0 ]) . long () y = torch . round ( points_2d_img [:, 1 ]) . long () # \u56fe\u50cf\u8303\u56f4\u5185 in_img = ( x >= 0 ) & ( x < W ) & ( y >= 0 ) & ( y < H ) # mask \u5185 x_in = x [ in_img ] y_in = y [ in_img ] inside = torch . zeros_like ( in_img ) inside [ in_img ] = ( mask [ y_in , x_in ] > 0 ) idx = torch . nonzero ( inside , as_tuple = False ) . squeeze ( 1 ) else : x1 , y1 , x2 , y2 = boxes_2d [ i ] x = points_2d_img [:, 0 ] y = points_2d_img [:, 1 ] inside = ( x >= x1 ) & ( x <= x2 ) & ( y >= y1 ) & ( y <= y2 ) idx = torch . nonzero ( inside , as_tuple = False ) . squeeze ( 1 ) if idx . numel () == 0 : counts [ i ] = 0 continue pts = points_3d_cam0 [ idx , : 3 ] # (Ni,3) n = min ( int ( pts . shape [ 0 ]), int ( max_points )) clusters [ i , : n , :] = pts [: n , :] counts [ i ] = n return clusters , counts frustum_histogram_clustering \u00b6 frustum_histogram_clustering ( clusters , counts , bins = 20 ) \u00b6 \u5bf9\u6bcf\u4e2a Frustum \u70b9\u4e91\u6267\u884c\u76f4\u65b9\u56fe\u805a\u7c7b\uff0c\u4f30\u8ba1\u76ee\u6807\u4e09\u7ef4\u8d28\u5fc3\u4f4d\u7f6e\u3002 \u8be5\u7b97\u5b50\u5bf9\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5206\u522b\u5728 x / y / z \u4e09\u4e2a\u8f74\u4e0a \u8fdb\u884c\u4e00\u7ef4\u76f4\u65b9\u56fe\u7edf\u8ba1\uff0c\u9009\u53d6\u70b9\u6570\u6700\u591a\u7684 bin \u533a\u95f4\u4e2d\u5fc3\u4f5c\u4e3a\u8be5\u8f74\u4f30\u8ba1\u503c\uff0c \u6700\u7ec8\u5f97\u5230\u6bcf\u4e2a\u76ee\u6807\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\u3002 Parameters: frustum_clusters \u2013 List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 Returns: centroids ( Tensor ) \u2013 (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 \u82e5\u67d0\u5b9e\u4f8b\u70b9\u4e91\u4e3a\u7a7a\uff0c\u5219\u5bf9\u5e94\u4f4d\u7f6e\u4e3a (0, 0, 0)\u3002 Source code in Frustum_Construction\\operator\\frustum_histogram_clustering.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @torch . library . custom_op ( \"faraway::frustum_histogram_clustering\" , mutates_args = []) def frustum_histogram_clustering ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) bins : int = 20 , ) -> torch . Tensor : \"\"\" \u5bf9\u6bcf\u4e2a Frustum \u70b9\u4e91\u6267\u884c\u76f4\u65b9\u56fe\u805a\u7c7b\uff0c\u4f30\u8ba1\u76ee\u6807\u4e09\u7ef4\u8d28\u5fc3\u4f4d\u7f6e\u3002 \u8be5\u7b97\u5b50\u5bf9\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5206\u522b\u5728 x / y / z \u4e09\u4e2a\u8f74\u4e0a \u8fdb\u884c\u4e00\u7ef4\u76f4\u65b9\u56fe\u7edf\u8ba1\uff0c\u9009\u53d6\u70b9\u6570\u6700\u591a\u7684 bin \u533a\u95f4\u4e2d\u5fc3\u4f5c\u4e3a\u8be5\u8f74\u4f30\u8ba1\u503c\uff0c \u6700\u7ec8\u5f97\u5230\u6bcf\u4e2a\u76ee\u6807\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\u3002 Args: frustum_clusters: List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 Returns: centroids: (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 \u82e5\u67d0\u5b9e\u4f8b\u70b9\u4e91\u4e3a\u7a7a\uff0c\u5219\u5bf9\u5e94\u4f4d\u7f6e\u4e3a (0, 0, 0)\u3002 \"\"\" device = clusters . device K = int ( clusters . shape [ 0 ]) centroids = torch . zeros (( K , 3 ), device = device , dtype = clusters . dtype ) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue pts = clusters [ i , : n , :] # (n,3) for d in range ( 3 ): values = pts [:, d ] vmin = torch . min ( values ) vmax = torch . max ( values ) if ( vmax - vmin ) . abs () < 1e-6 : centroids [ i , d ] = vmin continue hist = torch . histc ( values , bins = bins , min = float ( vmin ), max = float ( vmax )) max_bin = int ( torch . argmax ( hist ) . item ()) bin_w = ( vmax - vmin ) / float ( bins ) center = vmin + ( max_bin + 0.5 ) * bin_w centroids [ i , d ] = center return centroids faraway_object_decision \u00b6 faraway_object_decision ( centroids , labels , depth_thresholds ) \u00b6 \u8fdc\u8ddd\u79bb\u76ee\u6807\u5224\u5b9a\u7b97\u5b50\u3002 \u6839\u636e\u6bcf\u4e2a\u5b9e\u4f8b\u7684\u8d28\u5fc3\u6df1\u5ea6 z \u503c\u4ee5\u53ca\u7c7b\u522b\u5bf9\u5e94\u7684\u8ddd\u79bb\u9608\u503c\uff0c \u5224\u65ad\u8be5\u5b9e\u4f8b\u662f\u5426\u5c5e\u4e8e\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c\u4ece\u800c\u51b3\u5b9a\u540e\u7eed\u8d70 Faraway \u5206\u652f\u8fd8\u662f SOTA \u68c0\u6d4b\u5206\u652f\u3002 Parameters: centroids ( Tensor ) \u2013 (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 labels ( Tensor ) \u2013 (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u7c7b\u522b ID\u3002 depth_thresholds ( Tensor ) \u2013 (C,) \u6bcf\u4e2a\u7c7b\u522b\u5bf9\u5e94\u7684\u8fdc\u8ddd\u79bb\u6df1\u5ea6\u9608\u503c\uff0c C \u4e3a\u7c7b\u522b\u603b\u6570\uff0c\u7d22\u5f15\u4e0e labels \u5bf9\u5e94\u3002 Returns: is_faraway ( Tensor ) \u2013 (K,) \u5e03\u5c14\u5f20\u91cf\uff0cTrue \u8868\u793a\u8be5\u5b9e\u4f8b\u4e3a\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c False \u8868\u793a\u4e3a\u8fd1\u8ddd\u79bb\u76ee\u6807\u3002 Source code in Frustum_Construction\\operator\\faraway_object_decision.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @torch . library . custom_op ( \"faraway::faraway_object_decision\" , mutates_args = []) def faraway_object_decision ( centroids : torch . Tensor , labels : torch . Tensor , depth_thresholds : torch . Tensor , ) -> torch . Tensor : \"\"\" \u8fdc\u8ddd\u79bb\u76ee\u6807\u5224\u5b9a\u7b97\u5b50\u3002 \u6839\u636e\u6bcf\u4e2a\u5b9e\u4f8b\u7684\u8d28\u5fc3\u6df1\u5ea6 z \u503c\u4ee5\u53ca\u7c7b\u522b\u5bf9\u5e94\u7684\u8ddd\u79bb\u9608\u503c\uff0c \u5224\u65ad\u8be5\u5b9e\u4f8b\u662f\u5426\u5c5e\u4e8e\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c\u4ece\u800c\u51b3\u5b9a\u540e\u7eed\u8d70 Faraway \u5206\u652f\u8fd8\u662f SOTA \u68c0\u6d4b\u5206\u652f\u3002 Args: centroids: (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 labels: (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u7c7b\u522b ID\u3002 depth_thresholds: (C,) \u6bcf\u4e2a\u7c7b\u522b\u5bf9\u5e94\u7684\u8fdc\u8ddd\u79bb\u6df1\u5ea6\u9608\u503c\uff0c C \u4e3a\u7c7b\u522b\u603b\u6570\uff0c\u7d22\u5f15\u4e0e labels \u5bf9\u5e94\u3002 Returns: is_faraway: (K,) \u5e03\u5c14\u5f20\u91cf\uff0cTrue \u8868\u793a\u8be5\u5b9e\u4f8b\u4e3a\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c False \u8868\u793a\u4e3a\u8fd1\u8ddd\u79bb\u76ee\u6807\u3002 \"\"\" z_values = centroids [:, 2 ] # \u6839\u636e\u7c7b\u522b\u7d22\u5f15\u53d6\u5bf9\u5e94\u9608\u503c class_thresholds = depth_thresholds [ labels ] is_faraway = z_values > class_thresholds return is_faraway","title":"Frustum \u6784\u5efa\u9636\u6bb5 (Frustum Construction)"},{"location":"Frustum_Construction/#stage-1-frustum-constructionfrustum","text":"\ud83d\udca1 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u6839\u636e 2D \u5b9e\u4f8b\u4fe1\u606f\u6784\u5efa\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\uff0c\u5e76\u4f30\u8ba1\u76ee\u6807\u8d28\u5fc3\u4e0e\u8fdc\u8fd1\u7c7b\u522b \uff0c \u4e3a\u540e\u7eed Faraway \u7ec6\u5316\u9636\u6bb5\u63d0\u4f9b\u51e0\u4f55\u57fa\u7840\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e09\u4e2a\u7b97\u5b50\uff1a mask_frustum_pointcloud_crop \u6839\u636e 2D mask / box \u88c1\u526a\u70b9\u4e91\uff0c\u751f\u6210\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u7c07\u3002 frustum_histogram_clustering \u5bf9\u6bcf\u4e2a Frustum \u70b9\u4e91\u8fdb\u884c\u76f4\u65b9\u56fe\u7edf\u8ba1\uff0c\u4f30\u8ba1\u76ee\u6807\u8d28\u5fc3\u3002 faraway_object_decision \u6839\u636e\u6df1\u5ea6\u9608\u503c\u5224\u65ad\u76ee\u6807\u5c5e\u4e8e faraway \u8fd8\u662f near\u3002","title":"Stage 1 \u2013 Frustum Construction\uff08Frustum \u6784\u5efa\u9636\u6bb5\uff09"},{"location":"Frustum_Construction/#api","text":"","title":"API \u6587\u6863"},{"location":"Frustum_Construction/#mask_frustum_pointcloud_crop","text":"","title":"mask_frustum_pointcloud_crop"},{"location":"Frustum_Construction/#Frustum_Construction.operator.mask_frustum_pointcloud_crop.mask_frustum_pointcloud_crop","text":"\u6839\u636e 2D \u68c0\u6d4b\u7ed3\u679c\u751f\u6210\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5b50\u96c6\u3002 \u8be5\u7b97\u5b50\u5c06 LiDAR \u70b9\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u540e\uff0c \u6839\u636e 2D \u8fb9\u754c\u6846\u6216 2D \u5206\u5272\u63a9\u7801\u7b5b\u9009\u5c5e\u4e8e\u6bcf\u4e2a\u5b9e\u4f8b\u7684 3D \u70b9\uff0c \u6700\u7ec8\u8f93\u51fa\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u3002 Parameters: points_2d_img ( Tensor ) \u2013 (N, 2) \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684 2D \u70b9\u5750\u6807\u3002 points_3d_cam0 ( Tensor ) \u2013 (N, 3) \u5bf9\u5e94\u7684 3D \u70b9\uff08\u76f8\u673a\u5750\u6807\u7cfb\uff09\u3002 boxes_2d ( Tensor ) \u2013 (K, 4) 2D \u68c0\u6d4b\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 masks_2d ( Tensor ) \u2013 (K, H, W) 2D \u5206\u5272\u63a9\u7801\uff0c\u82e5\u4e3a None \u8868\u793a\u4ec5\u4f7f\u7528 2D \u6846\u3002 Returns: frustum_clusters ( Tuple [ Tensor , Tensor ] ) \u2013 (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\uff08\u53d8\u957f\u96c6\u5408\uff0c\u6309\u5b9e\u4f8b\u5212\u5206\uff09\u3002 Source code in Frustum_Construction\\operator\\mask_frustum_pointcloud_crop.py 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 @torch . library . custom_op ( \"faraway::mask_frustum_pointcloud_crop\" , mutates_args = []) def mask_frustum_pointcloud_crop ( points_2d_img : torch . Tensor , # (N, 2) points_3d_cam0 : torch . Tensor , # (N, 3) boxes_2d : torch . Tensor , # (K, 4) masks_2d : torch . Tensor , # (K, H, W) (\u53ef\u4f20\u7a7a Tensor: shape=(0,)) max_points : int = 2048 , ) -> Tuple [ torch . Tensor , torch . Tensor ]: \"\"\" \u6839\u636e 2D \u68c0\u6d4b\u7ed3\u679c\u751f\u6210\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5b50\u96c6\u3002 \u8be5\u7b97\u5b50\u5c06 LiDAR \u70b9\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u540e\uff0c \u6839\u636e 2D \u8fb9\u754c\u6846\u6216 2D \u5206\u5272\u63a9\u7801\u7b5b\u9009\u5c5e\u4e8e\u6bcf\u4e2a\u5b9e\u4f8b\u7684 3D \u70b9\uff0c \u6700\u7ec8\u8f93\u51fa\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u3002 Args: points_2d_img: (N, 2) \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684 2D \u70b9\u5750\u6807\u3002 points_3d_cam0: (N, 3) \u5bf9\u5e94\u7684 3D \u70b9\uff08\u76f8\u673a\u5750\u6807\u7cfb\uff09\u3002 boxes_2d: (K, 4) 2D \u68c0\u6d4b\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 masks_2d: (K, H, W) 2D \u5206\u5272\u63a9\u7801\uff0c\u82e5\u4e3a None \u8868\u793a\u4ec5\u4f7f\u7528 2D \u6846\u3002 Returns: frustum_clusters: (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\uff08\u53d8\u957f\u96c6\u5408\uff0c\u6309\u5b9e\u4f8b\u5212\u5206\uff09\u3002 \"\"\" device = points_3d_cam0 . device K = int ( boxes_2d . shape [ 0 ]) clusters = torch . zeros (( K , max_points , 3 ), device = device , dtype = points_3d_cam0 . dtype ) counts = torch . zeros (( K ,), device = device , dtype = torch . long ) use_mask = ( masks_2d is not None ) and ( masks_2d . numel () > 0 ) for i in range ( K ): if use_mask : mask = masks_2d [ i ] # (H, W) H , W = int ( mask . shape [ 0 ]), int ( mask . shape [ 1 ]) # \u6295\u5f71\u70b9\u53d6\u6574\u5230\u50cf\u7d20\u5750\u6807 x = torch . round ( points_2d_img [:, 0 ]) . long () y = torch . round ( points_2d_img [:, 1 ]) . long () # \u56fe\u50cf\u8303\u56f4\u5185 in_img = ( x >= 0 ) & ( x < W ) & ( y >= 0 ) & ( y < H ) # mask \u5185 x_in = x [ in_img ] y_in = y [ in_img ] inside = torch . zeros_like ( in_img ) inside [ in_img ] = ( mask [ y_in , x_in ] > 0 ) idx = torch . nonzero ( inside , as_tuple = False ) . squeeze ( 1 ) else : x1 , y1 , x2 , y2 = boxes_2d [ i ] x = points_2d_img [:, 0 ] y = points_2d_img [:, 1 ] inside = ( x >= x1 ) & ( x <= x2 ) & ( y >= y1 ) & ( y <= y2 ) idx = torch . nonzero ( inside , as_tuple = False ) . squeeze ( 1 ) if idx . numel () == 0 : counts [ i ] = 0 continue pts = points_3d_cam0 [ idx , : 3 ] # (Ni,3) n = min ( int ( pts . shape [ 0 ]), int ( max_points )) clusters [ i , : n , :] = pts [: n , :] counts [ i ] = n return clusters , counts","title":"mask_frustum_pointcloud_crop"},{"location":"Frustum_Construction/#frustum_histogram_clustering","text":"","title":"frustum_histogram_clustering"},{"location":"Frustum_Construction/#Frustum_Construction.operator.frustum_histogram_clustering.frustum_histogram_clustering","text":"\u5bf9\u6bcf\u4e2a Frustum \u70b9\u4e91\u6267\u884c\u76f4\u65b9\u56fe\u805a\u7c7b\uff0c\u4f30\u8ba1\u76ee\u6807\u4e09\u7ef4\u8d28\u5fc3\u4f4d\u7f6e\u3002 \u8be5\u7b97\u5b50\u5bf9\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5206\u522b\u5728 x / y / z \u4e09\u4e2a\u8f74\u4e0a \u8fdb\u884c\u4e00\u7ef4\u76f4\u65b9\u56fe\u7edf\u8ba1\uff0c\u9009\u53d6\u70b9\u6570\u6700\u591a\u7684 bin \u533a\u95f4\u4e2d\u5fc3\u4f5c\u4e3a\u8be5\u8f74\u4f30\u8ba1\u503c\uff0c \u6700\u7ec8\u5f97\u5230\u6bcf\u4e2a\u76ee\u6807\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\u3002 Parameters: frustum_clusters \u2013 List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 Returns: centroids ( Tensor ) \u2013 (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 \u82e5\u67d0\u5b9e\u4f8b\u70b9\u4e91\u4e3a\u7a7a\uff0c\u5219\u5bf9\u5e94\u4f4d\u7f6e\u4e3a (0, 0, 0)\u3002 Source code in Frustum_Construction\\operator\\frustum_histogram_clustering.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @torch . library . custom_op ( \"faraway::frustum_histogram_clustering\" , mutates_args = []) def frustum_histogram_clustering ( clusters : torch . Tensor , # (K, P, 3) counts : torch . Tensor , # (K,) bins : int = 20 , ) -> torch . Tensor : \"\"\" \u5bf9\u6bcf\u4e2a Frustum \u70b9\u4e91\u6267\u884c\u76f4\u65b9\u56fe\u805a\u7c7b\uff0c\u4f30\u8ba1\u76ee\u6807\u4e09\u7ef4\u8d28\u5fc3\u4f4d\u7f6e\u3002 \u8be5\u7b97\u5b50\u5bf9\u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u5206\u522b\u5728 x / y / z \u4e09\u4e2a\u8f74\u4e0a \u8fdb\u884c\u4e00\u7ef4\u76f4\u65b9\u56fe\u7edf\u8ba1\uff0c\u9009\u53d6\u70b9\u6570\u6700\u591a\u7684 bin \u533a\u95f4\u4e2d\u5fc3\u4f5c\u4e3a\u8be5\u8f74\u4f30\u8ba1\u503c\uff0c \u6700\u7ec8\u5f97\u5230\u6bcf\u4e2a\u76ee\u6807\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807\u3002 Args: frustum_clusters: List[(Ni, 3)] \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 Frustum \u70b9\u4e91\u96c6\u5408\uff0c Ni \u4e3a\u8be5\u5b9e\u4f8b\u5185\u7684\u70b9\u6570\u3002 Returns: centroids: (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u4f30\u8ba1\u5f97\u5230\u7684\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 \u82e5\u67d0\u5b9e\u4f8b\u70b9\u4e91\u4e3a\u7a7a\uff0c\u5219\u5bf9\u5e94\u4f4d\u7f6e\u4e3a (0, 0, 0)\u3002 \"\"\" device = clusters . device K = int ( clusters . shape [ 0 ]) centroids = torch . zeros (( K , 3 ), device = device , dtype = clusters . dtype ) for i in range ( K ): n = int ( counts [ i ] . item ()) if n <= 0 : continue pts = clusters [ i , : n , :] # (n,3) for d in range ( 3 ): values = pts [:, d ] vmin = torch . min ( values ) vmax = torch . max ( values ) if ( vmax - vmin ) . abs () < 1e-6 : centroids [ i , d ] = vmin continue hist = torch . histc ( values , bins = bins , min = float ( vmin ), max = float ( vmax )) max_bin = int ( torch . argmax ( hist ) . item ()) bin_w = ( vmax - vmin ) / float ( bins ) center = vmin + ( max_bin + 0.5 ) * bin_w centroids [ i , d ] = center return centroids","title":"frustum_histogram_clustering"},{"location":"Frustum_Construction/#faraway_object_decision","text":"","title":"faraway_object_decision"},{"location":"Frustum_Construction/#Frustum_Construction.operator.faraway_object_decision.faraway_object_decision","text":"\u8fdc\u8ddd\u79bb\u76ee\u6807\u5224\u5b9a\u7b97\u5b50\u3002 \u6839\u636e\u6bcf\u4e2a\u5b9e\u4f8b\u7684\u8d28\u5fc3\u6df1\u5ea6 z \u503c\u4ee5\u53ca\u7c7b\u522b\u5bf9\u5e94\u7684\u8ddd\u79bb\u9608\u503c\uff0c \u5224\u65ad\u8be5\u5b9e\u4f8b\u662f\u5426\u5c5e\u4e8e\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c\u4ece\u800c\u51b3\u5b9a\u540e\u7eed\u8d70 Faraway \u5206\u652f\u8fd8\u662f SOTA \u68c0\u6d4b\u5206\u652f\u3002 Parameters: centroids ( Tensor ) \u2013 (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 labels ( Tensor ) \u2013 (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u7c7b\u522b ID\u3002 depth_thresholds ( Tensor ) \u2013 (C,) \u6bcf\u4e2a\u7c7b\u522b\u5bf9\u5e94\u7684\u8fdc\u8ddd\u79bb\u6df1\u5ea6\u9608\u503c\uff0c C \u4e3a\u7c7b\u522b\u603b\u6570\uff0c\u7d22\u5f15\u4e0e labels \u5bf9\u5e94\u3002 Returns: is_faraway ( Tensor ) \u2013 (K,) \u5e03\u5c14\u5f20\u91cf\uff0cTrue \u8868\u793a\u8be5\u5b9e\u4f8b\u4e3a\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c False \u8868\u793a\u4e3a\u8fd1\u8ddd\u79bb\u76ee\u6807\u3002 Source code in Frustum_Construction\\operator\\faraway_object_decision.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @torch . library . custom_op ( \"faraway::faraway_object_decision\" , mutates_args = []) def faraway_object_decision ( centroids : torch . Tensor , labels : torch . Tensor , depth_thresholds : torch . Tensor , ) -> torch . Tensor : \"\"\" \u8fdc\u8ddd\u79bb\u76ee\u6807\u5224\u5b9a\u7b97\u5b50\u3002 \u6839\u636e\u6bcf\u4e2a\u5b9e\u4f8b\u7684\u8d28\u5fc3\u6df1\u5ea6 z \u503c\u4ee5\u53ca\u7c7b\u522b\u5bf9\u5e94\u7684\u8ddd\u79bb\u9608\u503c\uff0c \u5224\u65ad\u8be5\u5b9e\u4f8b\u662f\u5426\u5c5e\u4e8e\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c\u4ece\u800c\u51b3\u5b9a\u540e\u7eed\u8d70 Faraway \u5206\u652f\u8fd8\u662f SOTA \u68c0\u6d4b\u5206\u652f\u3002 Args: centroids: (K, 3) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u4e09\u7ef4\u8d28\u5fc3\u5750\u6807 (x, y, z)\u3002 labels: (K,) \u6bcf\u4e2a\u5b9e\u4f8b\u7684\u7c7b\u522b ID\u3002 depth_thresholds: (C,) \u6bcf\u4e2a\u7c7b\u522b\u5bf9\u5e94\u7684\u8fdc\u8ddd\u79bb\u6df1\u5ea6\u9608\u503c\uff0c C \u4e3a\u7c7b\u522b\u603b\u6570\uff0c\u7d22\u5f15\u4e0e labels \u5bf9\u5e94\u3002 Returns: is_faraway: (K,) \u5e03\u5c14\u5f20\u91cf\uff0cTrue \u8868\u793a\u8be5\u5b9e\u4f8b\u4e3a\u8fdc\u8ddd\u79bb\u76ee\u6807\uff0c False \u8868\u793a\u4e3a\u8fd1\u8ddd\u79bb\u76ee\u6807\u3002 \"\"\" z_values = centroids [:, 2 ] # \u6839\u636e\u7c7b\u522b\u7d22\u5f15\u53d6\u5bf9\u5e94\u9608\u503c class_thresholds = depth_thresholds [ labels ] is_faraway = z_values > class_thresholds return is_faraway","title":"faraway_object_decision"},{"location":"framework/","text":"Faraway-Frustum Framework\uff08\u878d\u5408\u4e3b\u6846\u67b6\uff09 \u00b6 Faraway-Frustum \u4e3b\u6846\u67b6\u5c06\u6240\u6709 Stage \u4e32\u8054\u8d77\u6765\uff0c\u5f62\u6210\u5b8c\u6574\u7684 2D\u20133D \u878d\u5408\u68c0\u6d4b\u6d41\u7a0b\u3002 \u4e3b\u878d\u5408\u6846\u67b6\uff0c\u5c06 2D/3D \u63a5\u53e3\u4e0e\u5404 Stage \u7b97\u5b50\u4e32\u8054\u5f62\u6210\u5b8c\u6574\u878d\u5408\u6d41\u7a0b\u3002 API \u6587\u6863 \u00b6 FarawayFrustumFramework \u00b6 Bases: Module Faraway-Frustum \u4e24\u9636\u6bb5\u878d\u5408\u6846\u67b6\u3002 \u8f93\u5165\uff1a - image : (B, 3, H, W) - point_cloud : \u539f\u59cb\u70b9\u4e91 - points_2d_img : \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684\u70b9 (N,2) - points_3d_cam0 : \u76f8\u673a\u5750\u6807\u7cfb\u70b9\u4e91 (N,3) - frustum_angles : \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 frustum \u89d2\u5ea6 (K,) \u8f93\u51fa\uff1a dict{ \"boxes_3d\": (M, 7), \"scores\": (M,), \"labels\": (M,) } Source code in framework.py 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 class FarawayFrustumFramework ( nn . Module ): \"\"\" Faraway-Frustum \u4e24\u9636\u6bb5\u878d\u5408\u6846\u67b6\u3002 \u8f93\u5165\uff1a - image : (B, 3, H, W) - point_cloud : \u539f\u59cb\u70b9\u4e91 - points_2d_img : \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684\u70b9 (N,2) - points_3d_cam0 : \u76f8\u673a\u5750\u6807\u7cfb\u70b9\u4e91 (N,3) - frustum_angles : \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 frustum \u89d2\u5ea6 (K,) \u8f93\u51fa\uff1a dict{ \"boxes_3d\": (M, 7), \"scores\": (M,), \"labels\": (M,) } \"\"\" def __init__ ( self , instance_2d_interface : Instance2DInterface , near_3d_interface : Near3DDetectionInterface , bev_height : int = 128 , bev_width : int = 128 , x_range : float = 40.0 , z_range : float = 70.0 , depth_thresholds : Optional [ torch . Tensor ] = None ): super () . __init__ () self . instance_2d = instance_2d_interface self . near_3d = near_3d_interface self . faraway_regressor = FarawayFrustumBoxRegression () self . bev_height = bev_height self . bev_width = bev_width self . x_range = x_range self . z_range = z_range # \u2705 \u652f\u6301\u5916\u90e8\u4f20\u5165 if depth_thresholds is None : self . depth_thresholds = torch . tensor ([ 30.0 , 40.0 , 50.0 ]) else : self . depth_thresholds = depth_thresholds # ============================================================ # Forward # ============================================================ def forward ( self , image : torch . Tensor , point_cloud : torch . Tensor , points_2d_img : torch . Tensor , points_3d_cam0 : torch . Tensor , frustum_angles : torch . Tensor , ): # ============================================================ # 1\ufe0f\u20e3 2D Instance Interface # ============================================================ instance_results = self . instance_2d ( image , points_2d_img = points_2d_img ) instance = instance_results [ 0 ] labels = instance [ \"labels\" ] boxes_2d = instance [ \"boxes\" ] masks_2d = instance [ \"masks\" ] # \u5982\u679c\u6ca1\u6709 2D \u5b9e\u4f8b\uff0c\u76f4\u63a5\u8d70 Near \u5206\u652f if boxes_2d . size ( 0 ) == 0 : return self . near_3d ( point_cloud , image ) K = boxes_2d . size ( 0 ) # \u5bf9\u9f50 frustum_angles if frustum_angles . numel () != K : frustum_angles = torch . zeros ( K , device = image . device ) # ============================================================ # Stage 1: Frustum Construction # ============================================================ clusters , counts = torch . ops . faraway . mask_frustum_pointcloud_crop ( points_2d_img , points_3d_cam0 , boxes_2d , masks_2d , 2048 , ) centroids = torch . ops . faraway . frustum_histogram_clustering ( clusters , counts , ) is_faraway = torch . ops . faraway . faraway_object_decision ( centroids , labels , self . depth_thresholds . to ( image . device ), ) faraway_indices = torch . nonzero ( is_faraway , as_tuple = False ) . squeeze ( 1 ) near_indices = torch . nonzero ( ~ is_faraway , as_tuple = False ) . squeeze ( 1 ) final_boxes = [] final_scores = [] final_labels = [] # ============================================================ # Stage 2: Faraway Refinement # ============================================================ if faraway_indices . numel () > 0 : f_clusters = clusters [ faraway_indices ] f_counts = counts [ faraway_indices ] f_centroids = centroids [ faraway_indices ] f_angles = frustum_angles [ faraway_indices ] aligned = torch . ops . faraway . frustum_axis_alignment ( f_clusters , f_counts , f_angles , ) local = torch . ops . faraway . centroid_coordinate_transform ( aligned , f_counts , f_centroids , ) bev_maps = torch . ops . faraway . frustum_bev_projection ( local , f_counts , self . bev_height , self . bev_width , self . x_range , self . z_range , ) regression_outputs = self . faraway_regressor ( bev_maps ) faraway_boxes = torch . ops . faraway . assemble_faraway_3d_box ( f_centroids , regression_outputs , ) final_boxes . append ( faraway_boxes ) final_scores . append ( torch . ones ( faraway_boxes . size ( 0 ), device = image . device ) ) final_labels . append ( labels [ faraway_indices ]) # ============================================================ # Near Branch # ============================================================ if near_indices . numel () > 0 : near_outputs = self . near_3d ( point_cloud , image ) final_boxes . append ( near_outputs [ \"boxes_3d\" ]) final_scores . append ( near_outputs [ \"scores\" ]) final_labels . append ( near_outputs [ \"labels\" ]) # ============================================================ # Merge # ============================================================ if len ( final_boxes ) == 0 : return { \"boxes_3d\" : torch . empty (( 0 , 7 ), device = image . device ), \"scores\" : torch . empty (( 0 ,), device = image . device ), \"labels\" : torch . empty (( 0 ,), dtype = torch . long , device = image . device ), } boxes_3d = torch . cat ( final_boxes , dim = 0 ) scores = torch . cat ( final_scores , dim = 0 ) labels = torch . cat ( final_labels , dim = 0 ) return { \"boxes_3d\" : boxes_3d , \"scores\" : scores , \"labels\" : labels , }","title":"Faraway-Frustum \u6846\u67b6\u7ed3\u6784"},{"location":"framework/#faraway-frustum-framework","text":"Faraway-Frustum \u4e3b\u6846\u67b6\u5c06\u6240\u6709 Stage \u4e32\u8054\u8d77\u6765\uff0c\u5f62\u6210\u5b8c\u6574\u7684 2D\u20133D \u878d\u5408\u68c0\u6d4b\u6d41\u7a0b\u3002 \u4e3b\u878d\u5408\u6846\u67b6\uff0c\u5c06 2D/3D \u63a5\u53e3\u4e0e\u5404 Stage \u7b97\u5b50\u4e32\u8054\u5f62\u6210\u5b8c\u6574\u878d\u5408\u6d41\u7a0b\u3002","title":"Faraway-Frustum Framework\uff08\u878d\u5408\u4e3b\u6846\u67b6\uff09"},{"location":"framework/#api","text":"","title":"API \u6587\u6863"},{"location":"framework/#farawayfrustumframework","text":"Bases: Module Faraway-Frustum \u4e24\u9636\u6bb5\u878d\u5408\u6846\u67b6\u3002 \u8f93\u5165\uff1a - image : (B, 3, H, W) - point_cloud : \u539f\u59cb\u70b9\u4e91 - points_2d_img : \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684\u70b9 (N,2) - points_3d_cam0 : \u76f8\u673a\u5750\u6807\u7cfb\u70b9\u4e91 (N,3) - frustum_angles : \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 frustum \u89d2\u5ea6 (K,) \u8f93\u51fa\uff1a dict{ \"boxes_3d\": (M, 7), \"scores\": (M,), \"labels\": (M,) } Source code in framework.py 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 class FarawayFrustumFramework ( nn . Module ): \"\"\" Faraway-Frustum \u4e24\u9636\u6bb5\u878d\u5408\u6846\u67b6\u3002 \u8f93\u5165\uff1a - image : (B, 3, H, W) - point_cloud : \u539f\u59cb\u70b9\u4e91 - points_2d_img : \u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u7684\u70b9 (N,2) - points_3d_cam0 : \u76f8\u673a\u5750\u6807\u7cfb\u70b9\u4e91 (N,3) - frustum_angles : \u6bcf\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684 frustum \u89d2\u5ea6 (K,) \u8f93\u51fa\uff1a dict{ \"boxes_3d\": (M, 7), \"scores\": (M,), \"labels\": (M,) } \"\"\" def __init__ ( self , instance_2d_interface : Instance2DInterface , near_3d_interface : Near3DDetectionInterface , bev_height : int = 128 , bev_width : int = 128 , x_range : float = 40.0 , z_range : float = 70.0 , depth_thresholds : Optional [ torch . Tensor ] = None ): super () . __init__ () self . instance_2d = instance_2d_interface self . near_3d = near_3d_interface self . faraway_regressor = FarawayFrustumBoxRegression () self . bev_height = bev_height self . bev_width = bev_width self . x_range = x_range self . z_range = z_range # \u2705 \u652f\u6301\u5916\u90e8\u4f20\u5165 if depth_thresholds is None : self . depth_thresholds = torch . tensor ([ 30.0 , 40.0 , 50.0 ]) else : self . depth_thresholds = depth_thresholds # ============================================================ # Forward # ============================================================ def forward ( self , image : torch . Tensor , point_cloud : torch . Tensor , points_2d_img : torch . Tensor , points_3d_cam0 : torch . Tensor , frustum_angles : torch . Tensor , ): # ============================================================ # 1\ufe0f\u20e3 2D Instance Interface # ============================================================ instance_results = self . instance_2d ( image , points_2d_img = points_2d_img ) instance = instance_results [ 0 ] labels = instance [ \"labels\" ] boxes_2d = instance [ \"boxes\" ] masks_2d = instance [ \"masks\" ] # \u5982\u679c\u6ca1\u6709 2D \u5b9e\u4f8b\uff0c\u76f4\u63a5\u8d70 Near \u5206\u652f if boxes_2d . size ( 0 ) == 0 : return self . near_3d ( point_cloud , image ) K = boxes_2d . size ( 0 ) # \u5bf9\u9f50 frustum_angles if frustum_angles . numel () != K : frustum_angles = torch . zeros ( K , device = image . device ) # ============================================================ # Stage 1: Frustum Construction # ============================================================ clusters , counts = torch . ops . faraway . mask_frustum_pointcloud_crop ( points_2d_img , points_3d_cam0 , boxes_2d , masks_2d , 2048 , ) centroids = torch . ops . faraway . frustum_histogram_clustering ( clusters , counts , ) is_faraway = torch . ops . faraway . faraway_object_decision ( centroids , labels , self . depth_thresholds . to ( image . device ), ) faraway_indices = torch . nonzero ( is_faraway , as_tuple = False ) . squeeze ( 1 ) near_indices = torch . nonzero ( ~ is_faraway , as_tuple = False ) . squeeze ( 1 ) final_boxes = [] final_scores = [] final_labels = [] # ============================================================ # Stage 2: Faraway Refinement # ============================================================ if faraway_indices . numel () > 0 : f_clusters = clusters [ faraway_indices ] f_counts = counts [ faraway_indices ] f_centroids = centroids [ faraway_indices ] f_angles = frustum_angles [ faraway_indices ] aligned = torch . ops . faraway . frustum_axis_alignment ( f_clusters , f_counts , f_angles , ) local = torch . ops . faraway . centroid_coordinate_transform ( aligned , f_counts , f_centroids , ) bev_maps = torch . ops . faraway . frustum_bev_projection ( local , f_counts , self . bev_height , self . bev_width , self . x_range , self . z_range , ) regression_outputs = self . faraway_regressor ( bev_maps ) faraway_boxes = torch . ops . faraway . assemble_faraway_3d_box ( f_centroids , regression_outputs , ) final_boxes . append ( faraway_boxes ) final_scores . append ( torch . ones ( faraway_boxes . size ( 0 ), device = image . device ) ) final_labels . append ( labels [ faraway_indices ]) # ============================================================ # Near Branch # ============================================================ if near_indices . numel () > 0 : near_outputs = self . near_3d ( point_cloud , image ) final_boxes . append ( near_outputs [ \"boxes_3d\" ]) final_scores . append ( near_outputs [ \"scores\" ]) final_labels . append ( near_outputs [ \"labels\" ]) # ============================================================ # Merge # ============================================================ if len ( final_boxes ) == 0 : return { \"boxes_3d\" : torch . empty (( 0 , 7 ), device = image . device ), \"scores\" : torch . empty (( 0 ,), device = image . device ), \"labels\" : torch . empty (( 0 ,), dtype = torch . long , device = image . device ), } boxes_3d = torch . cat ( final_boxes , dim = 0 ) scores = torch . cat ( final_scores , dim = 0 ) labels = torch . cat ( final_labels , dim = 0 ) return { \"boxes_3d\" : boxes_3d , \"scores\" : scores , \"labels\" : labels , }","title":"FarawayFrustumFramework"}]}